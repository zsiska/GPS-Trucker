<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>IES - Evidence cest</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiSUVTIC0gRXZpZGVuY2UgY2VzdCIsInNob3J0X25hbWUiOiJJRVMiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzAwMDAwMCIsInRoZW1lX2NvbG9yIjoiIzAwMDAwMCJ9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        :root {
            --primary: #007AFF;
            --secondary: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --background: #000000;
            --surface: #1C1C1E;
            --surface-elevated: #2C2C2E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --border: #38383A;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            height: 100vh;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: var(--surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 20px 20px 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .status-indicators {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .gps-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--secondary);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .gps-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .trip-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trip-status {
            font-size: 16px;
            font-weight: 600;
        }

        .trip-status.active {
            color: var(--secondary);
        }

        .trip-status.inactive {
            color: var(--text-secondary);
        }

        .time-display {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            border-radius: 20px 20px 0 0;
            z-index: 100;
            transform: translateY(0);
            transition: transform 0.3s ease;
            max-height: 60vh;
            overflow-y: auto;
        }

        .control-handle {
            width: 36px;
            height: 5px;
            background: var(--text-secondary);
            border-radius: 3px;
            margin: 12px auto 20px;
            cursor: pointer;
        }

        .control-content {
            padding: 0 20px 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--surface-elevated);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-secondary {
            background: var(--surface-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .form-section {
            background: var(--surface-elevated);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .form-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 16px;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .bottom-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 12px 20px calc(12px + var(--safe-area-bottom));
            z-index: 200;
            display: flex;
            justify-content: space-around;
        }

        .tab-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s ease;
            min-width: 60px;
        }

        .tab-btn.active {
            color: var(--primary);
            background: rgba(0, 122, 255, 0.1);
        }

        .tab-icon {
            font-size: 20px;
        }

        .tab-label {
            font-size: 10px;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--surface);
            border-radius: 20px;
            margin: 20px;
            width: calc(100% - 40px);
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 20px 20px 0;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
        }

        .modal-body {
            padding: 20px;
        }

        .toast {
            position: fixed;
            bottom: calc(100px + var(--safe-area-bottom));
            left: 20px;
            right: 20px;
            background: var(--surface-elevated);
            color: var(--text-primary);
            padding: 16px 20px;
            border-radius: 16px;
            z-index: 3000;
            display: none;
            animation: slideUp 0.3s ease;
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .trip-log {
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            background: var(--background);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid var(--primary);
        }

        .log-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .log-action {
            font-size: 14px;
            color: var(--text-primary);
        }

        .hidden {
            display: none !important;
        }

        .list-item {
            background: var(--surface-elevated);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .list-item-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .country-badge {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Map custom styles */
        .leaflet-popup-content-wrapper {
            background: var(--surface) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border) !important;
        }

        .leaflet-popup-tip {
            background: var(--surface) !important;
            border: 1px solid var(--border) !important;
        }

        .leaflet-control-zoom {
            background: var(--surface) !important;
            border: 1px solid var(--border) !important;
            border-radius: 12px !important;
        }

        .leaflet-control-zoom a {
            background: var(--surface) !important;
            color: var(--text-primary) !important;
            border: none !important;
        }

        .leaflet-control-attribution {
            background: rgba(28, 28, 30, 0.8) !important;
            color: var(--text-secondary) !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-top">
                <h1 class="app-title">üöõ IES</h1>
                <div class="status-indicators">
                    <div class="gps-indicator">
                        <div class="gps-dot"></div>
                        <span id="gpsStatus">GPS</span>
                    </div>
                </div>
            </div>
            <div class="trip-status-header">
                <div id="tripStatus" class="trip-status inactive">≈Ω√°dn√° aktivn√≠ cesta</div>
                <div id="currentTime" class="time-display"></div>
            </div>
        </header>

        <main class="main-content">
            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="control-panel" id="controlPanel">
                <div class="control-handle" onclick="togglePanel()"></div>
                
                <div class="control-content">
                    <!-- Active Trip Info -->
                    <div id="activeTripInfo" class="hidden">
                        <div class="form-section">
                            <h3>üöõ Aktivn√≠ j√≠zda</h3>
                            <div class="list-item">
                                <div class="list-item-content">
                                    <div class="list-item-title" id="activeTripDriver">≈òidiƒç</div>
                                    <div class="list-item-subtitle" id="activeTripVehicle">Vozidlo</div>
                                </div>
                            </div>
                            <div class="list-item">
                                <div class="list-item-content">
                                    <div class="list-item-title">Zah√°jeno: <span id="tripStartTime"></span></div>
                                    <div class="list-item-subtitle">
                                        Tachometr: <span id="tripStartOdo"></span> km | 
                                        N√°dr≈æ: <span id="tripStartFuel"></span>%
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="form-section">
                            <h3>‚ö° Rychl√© akce</h3>
                            <div class="action-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <button class="btn btn-warning" onclick="addQuickEvent('loading')">
                                    üì¶ Nakl√°dka
                                </button>
                                <button class="btn btn-warning" onclick="addQuickEvent('unloading')">
                                    üì§ Vykl√°dka
                                </button>
                                <button class="btn btn-secondary" onclick="addQuickEvent('break')">
                                    ‚òï P≈ôest√°vka
                                </button>
                                <button class="btn btn-secondary" onclick="addQuickEvent('fuel')">
                                    ‚õΩ Tankov√°n√≠
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="activeStats" class="hidden">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="tripDuration">00:00</div>
                                <div class="stat-label">Doba cesty</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="tripDistance">0</div>
                                <div class="stat-label">Ujet√© km</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="borderCrossings">0</div>
                                <div class="stat-label">P≈ôejezdy hranic</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="currentSpeed">0</div>
                                <div class="stat-label">km/h</div>
                            </div>
                        </div>
                    </div>

                    <!-- Trip Controls -->
                    <div id="tripControls">
                        <div class="action-buttons">
                            <button id="startTripBtn" class="btn btn-success" onclick="showStartTripForm()">
                                ‚ñ∂Ô∏è Zaƒç√≠t cestu
                            </button>
                            <button id="stopTripBtn" class="btn btn-danger hidden" onclick="stopTrip()">
                                ‚èπÔ∏è Ukonƒçit
                            </button>
                            <button id="addEventBtn" class="btn btn-warning hidden" onclick="showEventModal()">
                                üìù Ud√°lost
                            </button>
                        </div>
                    </div>

                    <!-- Start Trip Form -->
                    <div id="tripForm" class="hidden">
                        <div class="form-section">
                            <h3>Zaƒç√°tek cesty</h3>
                            <div class="form-group">
                                <label>≈òidiƒç</label>
                                <select id="driverSelect">
                                    <option value="">Vyberte ≈ôidiƒçe...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Vozidlo</label>
                                <select id="vehicleSelect">
                                    <option value="">Vyberte vozidlo...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Stav tachometru (km)</label>
                                <input type="number" id="startOdometer" placeholder="125000">
                            </div>
                            <div class="form-group">
                                <label>Stav n√°dr≈æe (%)</label>
                                <input type="number" id="startFuel" placeholder="80" min="0" max="100">
                            </div>
                            <button class="btn btn-primary" onclick="startTrip()" style="width: 100%;">
                                ‚úÖ Potvrdit zaƒç√°tek
                            </button>
                        </div>
                    </div>

                    <!-- Trip Log -->
                    <div id="tripLogSection" class="hidden">
                        <div class="form-section">
                            <h3>Log cesty</h3>
                            <div class="trip-log" id="tripLog"></div>
                        </div>
                    </div>

                    <!-- Current Location -->
                    <div class="form-section">
                        <h3>üìç Aktu√°ln√≠ pozice</h3>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                            <span id="currentCoords">Z√≠sk√°v√°m pozici...</span>
                            <span id="currentCountry" class="country-badge hidden">CZ</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Tabs -->
        <nav class="bottom-tabs">
            <button class="tab-btn active" onclick="switchTab('trip', this)">
                <div class="tab-icon">üó∫Ô∏è</div>
                <div class="tab-label">Mapa</div>
            </button>
            <button class="tab-btn" onclick="switchTab('drivers', this)">
                <div class="tab-icon">üë•</div>
                <div class="tab-label">≈òidiƒçi</div>
            </button>
            <button class="tab-btn" onclick="switchTab('vehicles', this)">
                <div class="tab-icon">üöö</div>
                <div class="tab-label">Vozidla</div>
            </button>
            <button class="tab-btn" onclick="switchTab('history', this)">
                <div class="tab-icon">üìä</div>
                <div class="tab-label">Historie</div>
            </button>
        </nav>
    </div>

    <!-- Modals -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üìù P≈ôidat ud√°lost</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Typ ud√°losti</label>
                    <select id="eventType">
                        <option value="loading">üì¶ Nakl√°dka</option>
                        <option value="unloading">üì§ Vykl√°dka</option>
                        <option value="break">‚òï Bezpeƒçnostn√≠ p≈ôest√°vka</option>
                        <option value="fuel">‚õΩ Tankov√°n√≠</option>
                        <option value="other">üìù Jin√©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Pozn√°mka</label>
                    <input type="text" id="eventNote" placeholder="Voliteln√° pozn√°mka...">
                </div>
                <div id="fuelSection" class="hidden">
                    <div class="form-group">
                        <label>Mno≈æstv√≠ paliva (l)</label>
                        <input type="number" id="fuelAmount" placeholder="50">
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addEvent()">‚úÖ P≈ôidat</button>
                    <button class="btn btn-secondary" onclick="closeModal('eventModal')">‚ùå Zru≈°it</button>
                </div>
            </div>
        </div>
    </div>

    <div id="driverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üë§ Nov√Ω ≈ôidiƒç</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Jm√©no</label>
                    <input type="text" id="driverName" placeholder="Jan Nov√°k">
                </div>
                <div class="form-group">
                    <label>ƒå√≠slo ≈ôidiƒçsk√©ho pr≈Økazu</label>
                    <input type="text" id="driverLicense" placeholder="B123456">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addDriver()">‚úÖ P≈ôidat</button>
                    <button class="btn btn-secondary" onclick="closeModal('driverModal')">‚ùå Zru≈°it</button>
                </div>
            </div>
        </div>
    </div>

    <div id="vehicleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üöö Nov√© vozidlo</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>SPZ</label>
                    <input type="text" id="vehiclePlate" placeholder="1A2 3456">
                </div>
                <div class="form-group">
                    <label>Typ vozidla</label>
                    <select id="vehicleType">
                        <option value="Kamion">üöõ Kamion</option>
                        <option value="Dod√°vka">üöê Dod√°vka</option>
                        <option value="Osobn√≠">üöó Osobn√≠</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Stav tachometru (km)</label>
                    <input type="number" id="vehicleOdometer" placeholder="125000">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addVehicle()">‚úÖ P≈ôidat</button>
                    <button class="btn btn-secondary" onclick="closeModal('vehicleModal')">‚ùå Zru≈°it</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Screens -->
    <div id="driversScreen" class="modal">
        <div class="modal-content" style="height: 80vh;">
            <div class="modal-header">üë• Katalog ≈ôidiƒç≈Ø</div>
            <div class="modal-body">
                <button class="btn btn-primary" onclick="showDriverModal()" style="width: 100%; margin-bottom: 20px;">
                    ‚ûï P≈ôidat ≈ôidiƒçe
                </button>
                <div id="driversList"></div>
            </div>
        </div>
    </div>

    <div id="vehiclesScreen" class="modal">
        <div class="modal-content" style="height: 80vh;">
            <div class="modal-header">üöö Katalog vozidel</div>
            <div class="modal-body">
                <button class="btn btn-primary" onclick="showVehicleModal()" style="width: 100%; margin-bottom: 20px;">
                    ‚ûï P≈ôidat vozidlo
                </button>
                <div id="vehiclesList"></div>
            </div>
        </div>
    </div>

    <div id="historyScreen" class="modal">
        <div class="modal-content" style="height: 80vh;">
            <div class="modal-header">üìä Historie cest</div>
            <div class="modal-body">
                <button class="btn btn-secondary" onclick="exportData()" style="width: 100%; margin-bottom: 20px;">
                    üì§ Export dat
                </button>
                <div id="tripHistory"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Glob√°ln√≠ promƒõnn√©
        let map = null;
        let currentPosition = null;
        let activeTrip = null;
        let watchId = null;
        let tripStartTime = null;
        let lastCountry = null;
        let totalDistance = 0;
        let borderCrossings = 0;
        let lastPosition = null;
        let tripTimer = null;
        let routePolyline = null;
        let startMarker = null;
        let currentMarker = null;
        let eventMarkers = [];

        // Naƒçten√≠ dat z localStorage
        let drivers = JSON.parse(localStorage.getItem('ies_drivers')) || [
            { id: 1, name: 'Jan Nov√°k', license: 'B123456' },
            { id: 2, name: 'Petr Svoboda', license: 'C789012' }
        ];

        let vehicles = JSON.parse(localStorage.getItem('ies_vehicles')) || [
            { id: 1, plate: '1A2 3456', type: 'Kamion', odometer: 125000 },
            { id: 2, plate: '2B3 4567', type: 'Dod√°vka', odometer: 89500 }
        ];

        let tripHistory = JSON.parse(localStorage.getItem('ies_trips')) || [];

        // Inicializace
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            startGPS();
            updateTime();
            setInterval(updateTime, 1000);
            populateSelects();
            updateLists();
            
            // Nastavit v√Ωchoz√≠ stav UI
            document.querySelector('.map-container').style.display = 'block';
            document.getElementById('controlPanel').style.display = 'block';
        });

        // Inicializace mapy
        function initMap() {
            // V√Ωchoz√≠ pozice - Praha
            const defaultPosition = [50.0755, 14.4378];
            
            map = L.map('map', {
                zoomControl: false,
                attributionControl: true
            }).setView(defaultPosition, 13);

            // Pou≈æit√≠ OpenStreetMap tiles s tmav√Ωm vzhledem
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // P≈ôidat zoom kontroly na pravou stranu
            L.control.zoom({
                position: 'topright'
            }).addTo(map);

            // P≈ôidat souƒçasnou pozici marker
            currentMarker = L.marker(defaultPosition, {
                icon: L.divIcon({
                    className: 'current-location-marker',
                    html: '<div style="background: #007AFF; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);
        }

        // GPS funkce
        function startGPS() {
            if (navigator.geolocation) {
                // Zkus√≠me z√≠skat pozici s del≈°√≠m timeoutem
                navigator.geolocation.getCurrentPosition(
                    position => {
                        currentPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            speed: position.coords.speed || 0,
                            timestamp: new Date()
                        };
                        
                        updateLocationDisplay();
                        updateMapPosition();
                        startWatching();
                        document.getElementById('gpsStatus').textContent = 'GPS';
                        showToast('GPS pozice z√≠sk√°na!');
                    },
                    error => {
                        console.error('GPS chyba:', error);
                        handleGPSError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 30000,
                        maximumAge: 60000
                    }
                );
            } else {
                // GPS nen√≠ podporov√°no - pou≈æijeme simulaci
                document.getElementById('gpsStatus').textContent = 'SIM';
                useSimulatedGPS();
            }
        }

        function handleGPSError(error) {
            let message = 'GPS chyba';
            document.getElementById('gpsStatus').textContent = 'GPS√ó';
            
            // Nab√≠dnout simulovanou polohu pro testov√°n√≠
            setTimeout(() => {
                if (confirm('GPS nefunguje. Chcete pou≈æ√≠t simulovanou polohu pro testov√°n√≠?')) {
                    useSimulatedGPS();
                }
            }, 2000);
        }

        function startWatching() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            watchId = navigator.geolocation.watchPosition(
                position => {
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        speed: position.coords.speed || 0,
                        timestamp: new Date()
                    };
                    
                    updateLocationDisplay();
                    updateMapPosition();
                    detectCountryChange();
                    
                    if (activeTrip) {
                        updateTripStats();
                        updateRouteOnMap();
                    }
                },
                error => {
                    console.warn('GPS watching error:', error);
                },
                {
                    enableHighAccuracy: false,
                    timeout: 20000,
                    maximumAge: 30000
                }
            );
        }

        // Simulovan√° GPS pro testov√°n√≠
        function useSimulatedGPS() {
            // Simulace cesty Praha -> Brno
            const route = [
                {lat: 50.0755, lng: 14.4378, name: 'Praha'},
                {lat: 50.0000, lng: 14.8000, name: 'Kol√≠n'},
                {lat: 49.8175, lng: 15.4730, name: 'Jihlava'},
                {lat: 49.5000, lng: 16.0000, name: 'T≈ôeb√≠ƒç'},
                {lat: 49.1951, lng: 16.6068, name: 'Brno'}
            ];
            
            let currentIndex = 0;
            currentPosition = {
                lat: route[0].lat,
                lng: route[0].lng,
                accuracy: 10,
                speed: 0,
                timestamp: new Date()
            };
            
            updateLocationDisplay();
            updateMapPosition();
            document.getElementById('gpsStatus').textContent = 'SIM';
            showToast('Pou≈æ√≠v√°m simulovanou GPS pro testov√°n√≠');
            
            // Simulace pohybu ka≈æd√Ωch 10 sekund
            setInterval(() => {
                if (activeTrip && currentIndex < route.length - 1) {
                    currentIndex++;
                    const targetPos = route[currentIndex];
                    
                    // Plynul√Ω p≈ôechod k dal≈°√≠ pozici
                    const steps = 20;
                    let step = 0;
                    const startLat = currentPosition.lat;
                    const startLng = currentPosition.lng;
                    
                    const moveInterval = setInterval(() => {
                        step++;
                        const progress = step / steps;
                        
                        currentPosition = {
                            lat: startLat + (targetPos.lat - startLat) * progress,
                            lng: startLng + (targetPos.lng - startLng) * progress,
                            accuracy: 10,
                            speed: 60 + Math.random() * 20, // 60-80 km/h
                            timestamp: new Date()
                        };
                        
                        updateLocationDisplay();
                        updateMapPosition();
                        detectCountryChange();
                        
                        if (activeTrip) {
                            updateTripStats();
                            updateRouteOnMap();
                        }
                        
                        if (step >= steps) {
                            clearInterval(moveInterval);
                        }
                    }, 500);
                    
                    if (currentIndex === route.length - 1) {
                        currentIndex = 0; // Restart na zaƒç√°tek
                    }
                }
            }, 10000);
        }

        function updateMapPosition() {
            if (!currentPosition || !map) return;
            
            const latlng = [currentPosition.lat, currentPosition.lng];
            
            // Aktualizovat marker souƒçasn√© pozice
            if (currentMarker) {
                currentMarker.setLatLng(latlng);
            }
            
            // Plynule p≈ôesunout mapu na novou pozici pouze pokud je to pot≈ôeba
            if (map.getCenter().distanceTo(latlng) > 100) {
                map.setView(latlng, map.getZoom(), {animate: true});
            }
        }

        function updateRouteOnMap() {
            if (!activeTrip || !currentPosition) return;
            
            // P≈ôidat aktu√°ln√≠ pozici do trasy
            if (activeTrip.route) {
                activeTrip.route.push([currentPosition.lat, currentPosition.lng]);
                
                // Aktualizovat polyline trasy
                if (routePolyline) {
                    routePolyline.setLatLngs(activeTrip.route);
                } else {
                    routePolyline = L.polyline(activeTrip.route, {
                        color: '#007AFF',
                        weight: 4,
                        opacity: 0.8
                    }).addTo(map);
                }
            }
        }

        function updateLocationDisplay() {
            const coords = currentPosition ? 
                `${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}` : 
                'Z√≠sk√°v√°m pozici...';
            
            document.getElementById('currentCoords').textContent = coords;
            
            if (currentPosition) {
                const country = detectCountry(currentPosition.lat, currentPosition.lng);
                const countryEl = document.getElementById('currentCountry');
                if (country !== 'Unknown') {
                    countryEl.textContent = country;
                    countryEl.classList.remove('hidden');
                } else {
                    countryEl.classList.add('hidden');
                }
            }
        }

        function detectCountry(lat, lng) {
            // Detekce zemƒõ podle GPS sou≈ôadnic
            if (lat >= 48.5 && lat <= 51.1 && lng >= 12.1 && lng <= 18.9) {
                return 'CZ';
            } else if (lat >= 47.3 && lat <= 49.0 && lng >= 16.8 && lng <= 22.6) {
                return 'SK';
            } else if (lat >= 47.4 && lat <= 49.0 && lng >= 9.5 && lng <= 17.2) {
                return 'AT';
            } else if (lat >= 49.0 && lat <= 54.8 && lng >= 14.1 && lng <= 24.1) {
                return 'PL';
            } else if (lat >= 47.3 && lat <= 54.7 && lng >= 5.9 && lng <= 15.0) {
                return 'DE';
            }
            return 'Unknown';
        }

        function detectCountryChange() {
            if (!currentPosition || !activeTrip) return;
            
            const currentCountry = detectCountry(currentPosition.lat, currentPosition.lng);
            
            if (lastCountry && lastCountry !== currentCountry && currentCountry !== 'Unknown') {
                borderCrossings++;
                addTripLogEntry(`üöß P≈ôejezd hranice: ${lastCountry} ‚Üí ${currentCountry}`, 'border');
                document.getElementById('borderCrossings').textContent = borderCrossings;
                showToast(`Detekov√°n p≈ôejezd hranice: ${lastCountry} ‚Üí ${currentCountry}`);
                
                // P≈ôidat marker hranice na mapu
                L.marker([currentPosition.lat, currentPosition.lng], {
                    icon: L.divIcon({
                        className: 'border-marker',
                        html: '<div style="background: #FF3B30; color: white; padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: bold; white-space: nowrap;">üöß ' + lastCountry + '‚Üí' + currentCountry + '</div>',
                        iconSize: [60, 20],
                        iconAnchor: [30, 10]
                    })
                }).addTo(map);
            }
            
            if (currentCountry !== 'Unknown') {
                lastCountry = currentCountry;
            }
        }

        // Spr√°va cest
        function showStartTripForm() {
            // Umo≈æn√≠me start i bez GPS pro testov√°n√≠
            document.getElementById('tripForm').classList.remove('hidden');
            
            // Pokud nen√≠ GPS, nab√≠dneme simulaci
            if (!currentPosition) {
                showToast('GPS nen√≠ dostupn√© - pou≈æije se simulovan√° pozice');
                // Nastav√≠me v√Ωchoz√≠ pozici (Praha)
                currentPosition = {
                    lat: 50.0755,
                    lng: 14.4378,
                    accuracy: 10,
                    speed: 0,
                    timestamp: new Date()
                };
                updateLocationDisplay();
                updateMapPosition();
            }
        }

        function startTrip() {
            const driverId = document.getElementById('driverSelect').value;
            const vehicleId = document.getElementById('vehicleSelect').value;
            const startOdometer = document.getElementById('startOdometer').value;
            const startFuel = document.getElementById('startFuel').value;
            
            if (!driverId || !vehicleId || !startOdometer || !startFuel) {
                showToast('Vypl≈àte v≈°echna povinn√° pole');
                return;
            }
            
            // Pokud st√°le nen√≠ GPS, pou≈æijeme v√Ωchoz√≠ pozici
            if (!currentPosition) {
                currentPosition = {
                    lat: 50.0755,
                    lng: 14.4378,
                    accuracy: 10,
                    speed: 0,
                    timestamp: new Date()
                };
                showToast('Pou≈æ√≠v√°m v√Ωchoz√≠ pozici (Praha)');
                updateMapPosition();
            }
            
            const driver = drivers.find(d => d.id == driverId);
            const vehicle = vehicles.find(v => v.id == vehicleId);
            
            activeTrip = {
                id: Date.now(),
                driverId: driverId,
                vehicleId: vehicleId,
                driverName: driver.name,
                vehiclePlate: vehicle.plate,
                startTime: new Date(),
                startPosition: {...currentPosition},
                startOdometer: parseInt(startOdometer),
                startFuel: parseInt(startFuel),
                events: [],
                route: [[currentPosition.lat, currentPosition.lng]]
            };
            
            tripStartTime = new Date();
            lastPosition = currentPosition;
            lastCountry = detectCountry(currentPosition.lat, currentPosition.lng);
            totalDistance = 0;
            borderCrossings = 0;
            
            // P≈ôidat start marker na mapu
            startMarker = L.marker([currentPosition.lat, currentPosition.lng], {
                icon: L.divIcon({
                    className: 'start-marker',
                    html: '<div style="background: #34C759; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">üöÄ Start</div>',
                    iconSize: [60, 20],
                    iconAnchor: [30, 10]
                })
            }).addTo(map);
            
            // UI aktualizace
            document.getElementById('tripStatus').textContent = 'Aktivn√≠ cesta';
            document.getElementById('tripStatus').className = 'trip-status active';
            document.getElementById('tripForm').classList.add('hidden');
            document.getElementById('startTripBtn').classList.add('hidden');
            document.getElementById('stopTripBtn').classList.remove('hidden');
            document.getElementById('addEventBtn').classList.remove('hidden');
            document.getElementById('activeStats').classList.remove('hidden');
            document.getElementById('tripLogSection').classList.remove('hidden');
            document.getElementById('activeTripInfo').classList.remove('hidden');
            
            // Vyplnit informace o aktivn√≠ j√≠zdƒõ
            document.getElementById('activeTripDriver').textContent = `üë§ ${driver.name}`;
            document.getElementById('activeTripVehicle').textContent = `üöö ${vehicle.plate} (${vehicle.type})`;
            document.getElementById('tripStartTime').textContent = tripStartTime.toLocaleString('cs-CZ');
            document.getElementById('tripStartOdo').textContent = parseInt(startOdometer).toLocaleString();
            document.getElementById('tripStartFuel').textContent = startFuel;
            
            // Spustit timer
            tripTimer = setInterval(updateTripDuration, 1000);
            
            addTripLogEntry(`üöÄ Cesta zah√°jena - ${driver.name}, ${vehicle.plate}`, 'start');
            addTripLogEntry(`üìç Start: ${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}`, 'location');
            
            showToast('Cesta byla zah√°jena');
        }

        function stopTrip() {
            if (!activeTrip) return;
            
            // Pokud nen√≠ GPS, pou≈æijeme posledn√≠ zn√°mou pozici
            if (!currentPosition && lastPosition) {
                currentPosition = lastPosition;
            } else if (!currentPosition) {
                // Nastav√≠me v√Ωchoz√≠ koncovou pozici
                currentPosition = {
                    lat: 49.1951,
                    lng: 16.6068,
                    accuracy: 10,
                    speed: 0,
                    timestamp: new Date()
                };
                showToast('Pou≈æ√≠v√°m v√Ωchoz√≠ koncovou pozici');
            }
            
            const endOdometer = prompt('Koneƒçn√Ω stav tachometru (km):', activeTrip.startOdometer + Math.round(totalDistance));
            const endFuel = prompt('Koneƒçn√Ω stav n√°dr≈æe (%):', '75');
            
            if (!endOdometer || !endFuel) return;
            
            activeTrip.endTime = new Date();
            activeTrip.endPosition = {...currentPosition};
            activeTrip.endOdometer = parseInt(endOdometer);
            activeTrip.endFuel = parseInt(endFuel);
            activeTrip.totalDistance = totalDistance;
            activeTrip.borderCrossings = borderCrossings;
            activeTrip.duration = (activeTrip.endTime - activeTrip.startTime) / 1000;
            
            // P≈ôidat end marker na mapu
            L.marker([currentPosition.lat, currentPosition.lng], {
                icon: L.divIcon({
                    className: 'end-marker',
                    html: '<div style="background: #FF3B30; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">üèÅ C√≠l</div>',
                    iconSize: [60, 20],
                    iconAnchor: [30, 10]
                })
            }).addTo(map);
            
            // Ulo≈æit do historie
            tripHistory.push(activeTrip);
            localStorage.setItem('ies_trips', JSON.stringify(tripHistory));
            
            addTripLogEntry(`üèÅ Cesta ukonƒçena`, 'end');
            addTripLogEntry(`üìç C√≠l: ${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}`, 'location');
            
            // Reset UI
            activeTrip = null;
            clearInterval(tripTimer);
            
            document.getElementById('tripStatus').textContent = '≈Ω√°dn√° aktivn√≠ cesta';
            document.getElementById('tripStatus').className = 'trip-status inactive';
            document.getElementById('startTripBtn').classList.remove('hidden');
            document.getElementById('stopTripBtn').classList.add('hidden');
            document.getElementById('addEventBtn').classList.add('hidden');
            document.getElementById('activeStats').classList.add('hidden');
            document.getElementById('tripLogSection').classList.add('hidden');
            document.getElementById('activeTripInfo').classList.add('hidden');
            
            document.getElementById('tripLog').innerHTML = '';
            
            showToast('Cesta byla ukonƒçena a ulo≈æena');
        }

        function updateTripStats() {
            if (!activeTrip || !currentPosition) return;
            
            // Vypoƒç√≠tat vzd√°lenost od posledn√≠ho bodu
            if (lastPosition) {
                const distance = calculateDistance(
                    lastPosition.lat, lastPosition.lng,
                    currentPosition.lat, currentPosition.lng
                );
                totalDistance += distance;
                lastPosition = currentPosition;
            }
            
            // Aktualizovat statistiky v UI
            document.getElementById('tripDistance').textContent = Math.round(totalDistance);
            document.getElementById('currentSpeed').textContent = 
                currentPosition.speed ? Math.round(currentPosition.speed * 3.6) : 0; // m/s -> km/h
        }

        function updateTripDuration() {
            if (!tripStartTime) return;
            
            const duration = Math.floor((new Date() - tripStartTime) / 1000);
            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            
            document.getElementById('tripDuration').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // polomƒõr Zemƒõ v km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Spr√°va ud√°lost√≠
        function showEventModal() {
            document.getElementById('eventModal').classList.add('show');
            
            // Zobrazit/skr√Ωt sekci paliva podle typu ud√°losti
            document.getElementById('eventType').onchange = function() {
                const fuelSection = document.getElementById('fuelSection');
                if (this.value === 'fuel') {
                    fuelSection.classList.remove('hidden');
                } else {
                    fuelSection.classList.add('hidden');
                }
            };
        }

        function addEvent() {
            if (!activeTrip) return;
            
            const type = document.getElementById('eventType').value;
            const note = document.getElementById('eventNote').value;
            const fuelAmount = document.getElementById('fuelAmount').value;
            
            const event = {
                id: Date.now(),
                type: type,
                timestamp: new Date(),
                position: currentPosition ? {...currentPosition} : null,
                note: note
            };
            
            if (type === 'fuel' && fuelAmount) {
                event.fuelAmount = parseFloat(fuelAmount);
            }
            
            activeTrip.events.push(event);
            
            // P≈ôidat marker ud√°losti na mapu
            if (currentPosition) {
                const eventMarker = L.marker([currentPosition.lat, currentPosition.lng], {
                    icon: L.divIcon({
                        className: 'event-marker',
                        html: '<div style="background: #FF9500; color: white; padding: 4px; border-radius: 50%; font-size: 14px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">' + getEventIcon(type) + '</div>',
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    })
                }).addTo(map);
                
                eventMarker.bindPopup(`<b>${getEventName(type)}</b><br>${note || ''}<br><small>${new Date().toLocaleTimeString()}</small>`);
                eventMarkers.push(eventMarker);
            }
            
            // P≈ôidat do logu
            let logText = getEventIcon(type) + ' ' + getEventName(type);
            if (note) logText += ` (${note})`;
            if (fuelAmount) logText += ` - ${fuelAmount}l`;
            
            addTripLogEntry(logText, type);
            
            // Vyƒçistit formul√°≈ô a zav≈ô√≠t modal
            document.getElementById('eventNote').value = '';
            document.getElementById('fuelAmount').value = '';
            document.getElementById('fuelSection').classList.add('hidden');
            closeModal('eventModal');
            
            showToast('Ud√°lost byla p≈ôid√°na');
        }

        function getEventIcon(type) {
            const icons = {
                'loading': 'üì¶',
                'unloading': 'üì§',
                'break': '‚òï',
                'fuel': '‚õΩ',
                'other': 'üìù'
            };
            return icons[type] || 'üìù';
        }

        function getEventName(type) {
            const names = {
                'loading': 'Nakl√°dka',
                'unloading': 'Vykl√°dka',
                'break': 'Bezpeƒçnostn√≠ p≈ôest√°vka',
                'fuel': 'Tankov√°n√≠',
                'other': 'Jin√° ud√°lost'
            };
            return names[type] || 'Ud√°lost';
        }

        function addTripLogEntry(text, type = '') {
            const logContainer = document.getElementById('tripLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const time = new Date().toLocaleTimeString('cs-CZ');
            const position = currentPosition ? 
                ` [${currentPosition.lat.toFixed(4)}, ${currentPosition.lng.toFixed(4)}]` : '';
            
            entry.innerHTML = `
                <div class="log-time">${time}${position}</div>
                <div class="log-action">${text}</div>
            `;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
            const logContainer = document.getElementById('tripLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const time = new Date().toLocaleTimeString('cs-CZ');
            const position = currentPosition ? 
                ` [${currentPosition.lat.toFixed(4)}, ${currentPosition.lng.toFixed(4)}]` : '';
            
            entry.innerHTML = `
                <div class="log-time">${time}${position}</div>
                <div class="log-action">${text}</div>
            `;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Spr√°va katalog≈Ø
        function populateSelects() {
            const driverSelect = document.getElementById('driverSelect');
            const vehicleSelect = document.getElementById('vehicleSelect');
            
            // Vyƒçistit seznamy
            driverSelect.innerHTML = '<option value="">Vyberte ≈ôidiƒçe...</option>';
            vehicleSelect.innerHTML = '<option value="">Vyberte vozidlo...</option>';
            
            // P≈ôidat ≈ôidiƒçe
            drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.id;
                option.textContent = `${driver.name} (${driver.license})`;
                driverSelect.appendChild(option);
            });
            
            // P≈ôidat vozidla
            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id;
                option.textContent = `${vehicle.plate} - ${vehicle.type}`;
                vehicleSelect.appendChild(option);
            });
        }

        function showDriverModal() {
            document.getElementById('driverModal').classList.add('show');
        }

        function showVehicleModal() {
            document.getElementById('vehicleModal').classList.add('show');
        }

        function addDriver() {
            const name = document.getElementById('driverName').value.trim();
            const license = document.getElementById('driverLicense').value.trim();
            
            if (!name || !license) {
                showToast('Vypl≈àte v≈°echna pole');
                return;
            }
            
            const newDriver = {
                id: Date.now(),
                name: name,
                license: license
            };
            
            drivers.push(newDriver);
            localStorage.setItem('ies_drivers', JSON.stringify(drivers));
            
            document.getElementById('driverName').value = '';
            document.getElementById('driverLicense').value = '';
            closeModal('driverModal');
            
            populateSelects();
            updateLists();
            showToast('≈òidiƒç byl p≈ôid√°n');
        }

        function addVehicle() {
            const plate = document.getElementById('vehiclePlate').value.trim();
            const type = document.getElementById('vehicleType').value;
            const odometer = document.getElementById('vehicleOdometer').value;
            
            if (!plate || !type || !odometer) {
                showToast('Vypl≈àte v≈°echna pole');
                return;
            }
            
            const newVehicle = {
                id: Date.now(),
                plate: plate,
                type: type,
                odometer: parseInt(odometer)
            };
            
            vehicles.push(newVehicle);
            localStorage.setItem('ies_vehicles', JSON.stringify(vehicles));
            
            document.getElementById('vehiclePlate').value = '';
            document.getElementById('vehicleOdometer').value = '';
            closeModal('vehicleModal');
            
            populateSelects();
            updateLists();
            showToast('Vozidlo bylo p≈ôid√°no');
        }

        function updateLists() {
            updateDriversList();
            updateVehiclesList();
        }

        function updateDriversList() {
            const container = document.getElementById('driversList');
            container.innerHTML = '';
            
            drivers.forEach(driver => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">üë§ ${driver.name}</div>
                        <div class="list-item-subtitle">Pr≈Økaz: ${driver.license}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function updateVehiclesList() {
            const container = document.getElementById('vehiclesList');
            container.innerHTML = '';
            
            vehicles.forEach(vehicle => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">üöö ${vehicle.plate}</div>
                        <div class="list-item-subtitle">${vehicle.type} - ${vehicle.odometer.toLocaleString()} km</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function exportData() {
            const data = {
                drivers: drivers,
                vehicles: vehicles,
                trips: tripHistory,
                exportDate: new Date().toISOString()
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `ies_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data byla exportov√°na');
        }

        // UI funkce
        function switchTab(tabName, element) {
            // Odstranit active z v≈°ech tab tlaƒç√≠tek
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Oznaƒçit aktivn√≠ tab tlaƒç√≠tko
            element.classList.add('active');
            
            // Zav≈ô√≠t v≈°echny screeny
            closeAllScreens();
            
            // Zobrazit vybran√Ω screen nebo mapu
            if (tabName === 'trip') {
                // Zobrazit mapu a control panel
                document.querySelector('.map-container').style.display = 'block';
                document.getElementById('controlPanel').style.display = 'block';
            } else {
                // Skr√Ωt mapu a zobrazit screen
                document.querySelector('.map-container').style.display = 'none';
                document.getElementById('controlPanel').style.display = 'none';
                document.getElementById(tabName + 'Screen').classList.add('show');
                
                if (tabName === 'history') {
                    updateHistory();
                } else if (tabName === 'drivers') {
                    updateDriversList();
                } else if (tabName === 'vehicles') {
                    updateVehiclesList();
                }
            }
        }

        function updateHistory() {
            const container = document.getElementById('tripHistory');
            container.innerHTML = '';
            
            if (tripHistory.length === 0) {
                container.innerHTML = '<div class="list-item"><div class="list-item-content"><div class="list-item-title">Zat√≠m ≈æ√°dn√© cesty</div></div></div>';
                return;
            }
            
            // Se≈ôadit podle data (nejnovƒõj≈°√≠ prvn√≠)
            const sortedTrips = [...tripHistory].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            
            sortedTrips.forEach(trip => {
                const startDate = new Date(trip.startTime).toLocaleDateString('cs-CZ');
                const startTime = new Date(trip.startTime).toLocaleTimeString('cs-CZ');
                const duration = trip.duration ? formatDuration(trip.duration) : 'N/A';
                const distance = trip.totalDistance ? Math.round(trip.totalDistance) : 0;
                
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="list-item-content">
                        <div class="list-item-title">üöõ ${startDate} ${startTime}</div>
                        <div class="list-item-subtitle">
                            ${trip.driverName} - ${trip.vehiclePlate}<br>
                            üìè ${distance} km | ‚è±Ô∏è ${duration} | üöß ${trip.borderCrossings || 0} hranic
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        function closeAllScreens() {
            document.getElementById('driversScreen').classList.remove('show');
            document.getElementById('vehiclesScreen').classList.remove('show');
            document.getElementById('historyScreen').classList.remove('show');
            
            // Obnovit viditelnost mapy a control panelu
            document.querySelector('.map-container').style.display = 'block';
            document.getElementById('controlPanel').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
        }

        function togglePanel() {
            const panel = document.getElementById('controlPanel');
            const isCollapsed = panel.style.transform === 'translateY(60%)';
            
            if (isCollapsed) {
                panel.style.transform = 'translateY(0)';
            } else {
                panel.style.transform = 'translateY(60%)';
            }
        }

        // Zav≈ôen√≠ mod√°l≈Ø p≈ôi kliknut√≠ mimo
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // Prevent zoom na double-tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Gesture handling pro panel
        let startY = 0;
        let currentY = 0;
        let isDragging = false;

        document.getElementById('controlPanel').addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
            isDragging = true;
        });

        document.getElementById('controlPanel').addEventListener('touchmove', function(e) {
            if (!isDragging) return;
            
            currentY = e.touches[0].clientY;
            const deltaY = currentY - startY;
            
            if (deltaY > 0) {
                const translateY = Math.min(deltaY * 0.5, window.innerHeight * 0.6);
                this.style.transform = `translateY(${translateY}px)`;
            }
        });

        document.getElementById('controlPanel').addEventListener('touchend', function(e) {
            if (!isDragging) return;
            isDragging = false;
            
            const deltaY = currentY - startY;
            
            if (deltaY > 100) {
                // Collapse panel
                this.style.transform = 'translateY(60%)';
            } else {
                // Expand panel
                this.style.transform = 'translateY(0)';
            }
        });

        // Service Worker pro PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                const swCode = `
                    const CACHE_NAME = 'ies-v2';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });
                    
                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('SW registered');
                    })
                    .catch(function(error) {
                        console.log('SW registration failed');
                    });
            });
        }

        // Orientace handling
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                }
            }, 100);
        });

        // Resize handling
        window.addEventListener('resize', function() {
            if (map) {
                map.invalidateSize();
            }
        });

        // Prevence refreshe p≈ôi pull-down
        let preventPullToRefresh = false;

        document.body.addEventListener('touchstart', e => {
            if (e.touches.length !== 1) return;
            
            const touch = e.touches[0];
            const targetElement = e.target.closest('.main-content, .control-panel');
            
            if (targetElement && window.pageYOffset <= 0 && touch.clientY > 10) {
                preventPullToRefresh = true;
            }
        });

        document.body.addEventListener('touchmove', e => {
            if (preventPullToRefresh) {
                e.preventDefault();
            }
        }, { passive: false });

        document.body.addEventListener('touchend', e => {
            preventPullToRefresh = false;
        });

        // Keyboard handling pro mobile
        const viewport = document.querySelector('meta[name=viewport]');
        const originalContent = viewport.getAttribute('content');

        // Detekce virtual keyboard
        let initialViewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;

        function handleViewportChange() {
            const currentHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
            const heightDifference = initialViewportHeight - currentHeight;
            
            if (heightDifference > 150) {
                // Keyboard is visible
                document.body.style.paddingBottom = `${heightDifference}px`;
            } else {
                // Keyboard is hidden
                document.body.style.paddingBottom = 'env(safe-area-inset-bottom)';
            }
        }

        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', handleViewportChange);
        } else {
            window.addEventListener('resize', handleViewportChange);
        }

        // Focus handling pro inputs
        document.addEventListener('focusin', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                setTimeout(() => {
                    e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        });

        // Optimalizace battery life
        let isAppVisible = true;

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                isAppVisible = false;
                // Sn√≠≈æit frekvenci GPS updates kdy≈æ je app na pozad√≠
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    // Nastavit m√©nƒõ ƒçast√© sledov√°n√≠
                    watchId = navigator.geolocation.watchPosition(
                        position => {
                            // Stejn√° logika ale s ni≈æ≈°√≠ frekvenc√≠
                            currentPosition = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                speed: position.coords.speed || 0,
                                timestamp: new Date()
                            };
                            
                            if (activeTrip) {
                                updateTripStats();
                                updateRouteOnMap();
                            }
                        },
                        error => console.warn('Background GPS error:', error),
                        {
                            enableHighAccuracy: false,
                            timeout: 60000,
                            maximumAge: 120000
                        }
                    );
                }
            } else {
                isAppVisible = true;
                // Obnovit plnou frekvenci GPS updates
                if (navigator.geolocation) {
                    startWatching();
                }
            }
        });

        // Error boundary
        window.addEventListener('error', function(e) {
            console.error('App error:', e.error);
            showToast('Do≈°lo k chybƒõ aplikace');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showToast('Do≈°lo k neoƒçek√°van√© chybƒõ');
            e.preventDefault();
        });

        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    console.log('App load time:', perfData.loadEventEnd - perfData.fetchStart, 'ms');
                }, 0);
            });
        }

        // Memory cleanup p≈ôi unload
        window.addEventListener('beforeunload', function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            if (tripTimer) {
                clearInterval(tripTimer);
            }
            if (map) {
                map.remove();
            }
        });
    </script>
</body>
</html>
