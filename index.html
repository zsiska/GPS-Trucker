<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Tracker - Sledov√°n√≠ trasy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        
        .status.stopped { background: #ff6b6b; color: white; }
        .status.driving { background: #4ecdc4; color: white; }
        .status.loading { background: #ffe66d; color: #333; }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
        }
        
        .info-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .info-card p {
            color: #666;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-start {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }
        
        .btn-stop {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }
        
        .btn-loading, .btn-unloading {
            background: linear-gradient(45deg, #ffe66d, #ffd93d);
            color: #333;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .route-log {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .route-log h3 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .log-entry {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }
        
        .log-entry.start { border-left-color: #4ecdc4; background: #f0fdfc; }
        .log-entry.stop { border-left-color: #ff6b6b; background: #fef2f2; }
        .log-entry.border { border-left-color: #9c88ff; background: #f5f3ff; }
        .log-entry.loading { border-left-color: #ffe66d; background: #fffbeb; }
        
        .log-time {
            font-weight: bold;
            color: #667eea;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .modal h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        @media (max-width: 600px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöõ GPS Tracker</h1>
            <div id="status" class="status stopped">Zastaveno</div>
        </div>
        
        <div class="info-grid">
            <div class="info-card">
                <h3>üìç Aktu√°ln√≠ pozice</h3>
                <p id="currentPosition">Naƒç√≠t√°n√≠...</p>
            </div>
            
            <div class="info-card">
                <h3>üèÅ Zaƒç√°tek cesty</h3>
                <p id="startTime">-</p>
            </div>
            
            <div class="info-card">
                <h3>‚è±Ô∏è Doba j√≠zdy</h3>
                <p id="drivingTime">00:00:00</p>
            </div>
            
            <div class="info-card">
                <h3>üåç Aktu√°ln√≠ zemƒõ</h3>
                <p id="currentCountry">Nezn√°m√°</p>
            </div>
        </div>
        
        <div class="controls">
            <button id="startBtn" class="btn btn-start">üöÄ Zaƒç√≠t cestu</button>
            <button id="stopBtn" class="btn btn-stop" disabled>‚èπÔ∏è Ukonƒçit cestu</button>
            <button id="loadingBtn" class="btn btn-loading" disabled>üì¶ Nakl√°dka</button>
            <button id="unloadingBtn" class="btn btn-unloading" disabled>üì§ Vykl√°dka</button>
        </div>
        
        <div class="route-log">
            <h3>üìã Z√°znam cesty</h3>
            <div id="logEntries"></div>
        </div>
    </div>
    
    <!-- Modal pro potvrzen√≠ zastaven√≠ -->
    <div id="stopModal" class="modal">
        <div class="modal-content">
            <h3>Vozidlo se zastavilo</h3>
            <p>Co se dƒõje?</p>
            <div class="modal-buttons">
                <button id="modalLoading" class="btn btn-loading">üì¶ Nakl√°dka</button>
                <button id="modalUnloading" class="btn btn-unloading">üì§ Vykl√°dka</button>
                <button id="modalContinue" class="btn btn-start">‚û°Ô∏è Pokraƒçovat v j√≠zdƒõ</button>
                <button id="modalEnd" class="btn btn-stop">üèÅ Konec cesty</button>
            </div>
        </div>
    </div>

    <script>
        class GPSTracker {
            constructor() {
                this.isTracking = false;
                this.startTime = null;
                this.lastPosition = null;
                this.lastCountry = null;
                this.route = [];
                this.currentActivity = null;
                this.activityStartTime = null;
                this.watchId = null;
                this.speedThreshold = 2; // m/s (cca 7 km/h)
                this.isStationary = false;
                this.stationaryStartTime = null;
                this.stationaryThreshold = 30000; // 30 sekund
                
                this.initElements();
                this.bindEvents();
                this.getCurrentPosition();
                this.updateTimer();
            }
            
            initElements() {
                this.elements = {
                    startBtn: document.getElementById('startBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    loadingBtn: document.getElementById('loadingBtn'),
                    unloadingBtn: document.getElementById('unloadingBtn'),
                    status: document.getElementById('status'),
                    currentPosition: document.getElementById('currentPosition'),
                    startTime: document.getElementById('startTime'),
                    drivingTime: document.getElementById('drivingTime'),
                    currentCountry: document.getElementById('currentCountry'),
                    logEntries: document.getElementById('logEntries'),
                    stopModal: document.getElementById('stopModal'),
                    modalLoading: document.getElementById('modalLoading'),
                    modalUnloading: document.getElementById('modalUnloading'),
                    modalContinue: document.getElementById('modalContinue'),
                    modalEnd: document.getElementById('modalEnd')
                };
            }
            
            bindEvents() {
                this.elements.startBtn.addEventListener('click', () => this.startTracking());
                this.elements.stopBtn.addEventListener('click', () => this.stopTracking());
                this.elements.loadingBtn.addEventListener('click', () => this.startActivity('loading'));
                this.elements.unloadingBtn.addEventListener('click', () => this.startActivity('unloading'));
                
                this.elements.modalLoading.addEventListener('click', () => this.handleStopModal('loading'));
                this.elements.modalUnloading.addEventListener('click', () => this.handleStopModal('unloading'));
                this.elements.modalContinue.addEventListener('click', () => this.handleStopModal('continue'));
                this.elements.modalEnd.addEventListener('click', () => this.handleStopModal('end'));
            }
            
            getCurrentPosition() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => this.updatePosition(position),
                        (error) => this.handleLocationError(error),
                        { enableHighAccuracy: true, maximumAge: 10000, timeout: 15000 }
                    );
                } else {
                    this.elements.currentPosition.textContent = 'Geolokace nen√≠ podporov√°na';
                }
            }
            
            async updatePosition(position) {
                const { latitude, longitude, speed } = position.coords;
                const currentSpeed = speed || 0;
                
                // Aktualizace pozice v UI
                this.elements.currentPosition.textContent = 
                    `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                
                // Z√≠sk√°n√≠ zemƒõ z koordin√°t≈Ø
                try {
                    const country = await this.getCountryFromCoords(latitude, longitude);
                    if (country !== this.lastCountry && this.lastCountry !== null) {
                        this.logBorderCrossing(this.lastCountry, country);
                    }
                    this.lastCountry = country;
                    this.elements.currentCountry.textContent = country;
                } catch (error) {
                    console.error('Chyba p≈ôi z√≠sk√°v√°n√≠ zemƒõ:', error);
                }
                
                if (this.isTracking) {
                    // Zaznamen√°n√≠ pozice do trasy
                    this.route.push({
                        timestamp: new Date(),
                        latitude,
                        longitude,
                        speed: currentSpeed,
                        country: this.lastCountry
                    });
                    
                    // Detekce zastaven√≠
                    this.checkIfStationary(currentSpeed);
                }
                
                this.lastPosition = { latitude, longitude };
            }
            
            checkIfStationary(speed) {
                const isCurrentlyStationary = speed < this.speedThreshold;
                
                if (isCurrentlyStationary && !this.isStationary) {
                    // Pr√°vƒõ se zastavilo
                    this.isStationary = true;
                    this.stationaryStartTime = Date.now();
                } else if (!isCurrentlyStationary && this.isStationary) {
                    // Pr√°vƒõ se rozjelo
                    this.isStationary = false;
                    this.stationaryStartTime = null;
                    this.updateStatus('driving');
                } else if (isCurrentlyStationary && this.isStationary) {
                    // St√°le stoj√≠ - zkontrolovat, jak dlouho
                    const stationaryDuration = Date.now() - this.stationaryStartTime;
                    if (stationaryDuration > this.stationaryThreshold && !this.currentActivity) {
                        // Zobrazit modal pro v√Ωbƒõr aktivity
                        this.showStopModal();
                    }
                }
            }
            
            showStopModal() {
                this.elements.stopModal.style.display = 'block';
            }
            
            hideStopModal() {
                this.elements.stopModal.style.display = 'none';
            }
            
            handleStopModal(action) {
                this.hideStopModal();
                
                switch (action) {
                    case 'loading':
                        this.startActivity('loading');
                        break;
                    case 'unloading':
                        this.startActivity('unloading');
                        break;
                    case 'continue':
                        // Pokraƒçovat v j√≠zdƒõ - nic nedƒõlat
                        break;
                    case 'end':
                        this.stopTracking();
                        break;
                }
            }
            
            async getCountryFromCoords(lat, lon) {
                try {
                    // Pou≈æit√≠ Nominatim API pro reverse geocoding
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=cs`
                    );
                    const data = await response.json();
                    return data.address?.country || 'Nezn√°m√° zemƒõ';
                } catch (error) {
                    return 'Nezn√°m√° zemƒõ';
                }
            }
            
            startTracking() {
                this.isTracking = true;
                this.startTime = new Date();
                this.elements.startTime.textContent = this.startTime.toLocaleString('cs-CZ');
                
                this.updateStatus('driving');
                this.updateButtons();
                this.logEntry('Zaƒç√°tek cesty', 'start');
                
                // Spustit sledov√°n√≠ polohy
                if (navigator.geolocation) {
                    this.watchId = navigator.geolocation.watchPosition(
                        (position) => this.updatePosition(position),
                        (error) => this.handleLocationError(error),
                        { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
                    );
                }
            }
            
            stopTracking() {
                this.isTracking = false;
                
                if (this.currentActivity) {
                    this.endActivity();
                }
                
                this.updateStatus('stopped');
                this.updateButtons();
                this.logEntry('Konec cesty', 'stop');
                
                // Zastavit sledov√°n√≠ polohy
                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }
                
                // Vyexportovat data cesty
                this.exportRoute();
            }
            
            startActivity(type) {
                if (this.currentActivity) {
                    this.endActivity();
                }
                
                this.currentActivity = type;
                this.activityStartTime = new Date();
                
                const activityName = type === 'loading' ? 'Nakl√°dka' : 'Vykl√°dka';
                this.updateStatus(type);
                this.logEntry(`Zaƒç√°tek: ${activityName}`, 'loading');
                
                this.updateButtons();
            }
            
            endActivity() {
                if (!this.currentActivity || !this.activityStartTime) return;
                
                const endTime = new Date();
                const duration = endTime - this.activityStartTime;
                const activityName = this.currentActivity === 'loading' ? 'Nakl√°dka' : 'Vykl√°dka';
                
                this.logEntry(
                    `Konec: ${activityName} (${this.formatDuration(duration)})`, 
                    'loading'
                );
                
                this.currentActivity = null;
                this.activityStartTime = null;
                this.updateStatus('driving');
                this.updateButtons();
            }
            
            logBorderCrossing(fromCountry, toCountry) {
                this.logEntry(`P≈ôekroƒçen√≠ hranice: ${fromCountry} ‚Üí ${toCountry}`, 'border');
            }
            
            updateStatus(status) {
                const statusText = {
                    stopped: 'Zastaveno',
                    driving: 'J√≠zda',
                    loading: 'Nakl√°dka',
                    unloading: 'Vykl√°dka'
                };
                
                this.elements.status.textContent = statusText[status] || 'Nezn√°m√Ω';
                this.elements.status.className = `status ${status}`;
            }
            
            updateButtons() {
                this.elements.startBtn.disabled = this.isTracking;
                this.elements.stopBtn.disabled = !this.isTracking;
                this.elements.loadingBtn.disabled = !this.isTracking || this.currentActivity === 'loading';
                this.elements.unloadingBtn.disabled = !this.isTracking || this.currentActivity === 'unloading';
            }
            
            logEntry(message, type = '') {
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.innerHTML = `
                    <span class="log-time">${new Date().toLocaleString('cs-CZ')}</span><br>
                    ${message}
                `;
                
                this.elements.logEntries.insertBefore(entry, this.elements.logEntries.firstChild);
            }
            
            updateTimer() {
                if (this.isTracking && this.startTime) {
                    const elapsed = new Date() - this.startTime;
                    this.elements.drivingTime.textContent = this.formatDuration(elapsed);
                }
                
                setTimeout(() => this.updateTimer(), 1000);
            }
            
            formatDuration(milliseconds) {
                const seconds = Math.floor(milliseconds / 1000) % 60;
                const minutes = Math.floor(milliseconds / (1000 * 60)) % 60;
                const hours = Math.floor(milliseconds / (1000 * 60 * 60));
                
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            exportRoute() {
                const data = {
                    startTime: this.startTime,
                    endTime: new Date(),
                    route: this.route,
                    totalDistance: this.calculateTotalDistance(),
                    countries: [...new Set(this.route.map(point => point.country))]
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trasa_${this.startTime.toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            calculateTotalDistance() {
                let total = 0;
                for (let i = 1; i < this.route.length; i++) {
                    const prev = this.route[i - 1];
                    const curr = this.route[i];
                    total += this.haversineDistance(prev.latitude, prev.longitude, curr.latitude, curr.longitude);
                }
                return total;
            }
            
            haversineDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3;
                const œÜ1 = lat1 * Math.PI / 180;
                const œÜ2 = lat2 * Math.PI / 180;
                const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
                const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
                
                const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                         Math.cos(œÜ1) * Math.cos(œÜ2) *
                         Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                
                return R * c;
            }
            
            handleLocationError(error) {
                let errorMsg = 'Chyba p≈ôi z√≠sk√°v√°n√≠ polohy: ';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg += 'P≈ô√≠stup k poloze byl zam√≠tnut';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg += 'Poloha nen√≠ dostupn√°';
                        break;
                    case error.TIMEOUT:
                        errorMsg += 'Vypr≈°el ƒçasov√Ω limit';
                        break;
                    default:
                        errorMsg += 'Nezn√°m√° chyba';
                }
                this.elements.currentPosition.textContent = errorMsg;
            }
        }
        
        // Inicializace aplikace
        window.addEventListener('load', () => {
            new GPSTracker();
        });
    </script>
</body>
</html>