<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Elektronick√° stazka - Fixed</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * {margin:0;padding:0;box-sizing:border-box}
    body {font-family:system-ui,-apple-system,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;display:flex;flex-direction:column}
    
    .header {padding:1rem;background:#1e293b;border-bottom:1px solid #334155}
    .header-top {display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
    .brand {font-size:1.2rem;font-weight:bold}
    .status {display:flex;gap:1rem;font-size:0.9rem;color:#94a3b8}
    .dot {width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:0.3rem}
    .dot.green {background:#22c55e}
    .dot.yellow {background:#f59e0b}
    .dot.red {background:#ef4444}
    
    /* Enhanced mode indicator */
    .mode-indicator {
      padding:0.5rem 1rem;
      border-radius:25px;
      font-weight:bold;
      font-size:0.9rem;
      animation:pulse 2s infinite;
    }
    .mode-indicator.driving {background:#22c55e;color:white;border:2px solid #16a34a}
    .mode-indicator.loading {background:#3b82f6;color:white;border:2px solid #2563eb}
    .mode-indicator.unloading {background:#f59e0b;color:white;border:2px solid #d97706}
    .mode-indicator.fueling {background:#8b5cf6;color:white;border:2px solid #7c3aed}
    .mode-indicator.repair {background:#ef4444;color:white;border:2px solid #dc2626}
    .mode-indicator.break {background:#64748b;color:white;border:2px solid #475569}
    .mode-indicator.idle {background:#334155;color:#e2e8f0;border:2px solid #475569}
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .steps {display:flex;gap:0.5rem;flex-wrap:wrap}
    .step {padding:0.3rem 0.6rem;border:1px solid #334155;border-radius:20px;font-size:0.85rem;color:#94a3b8}
    .step.active {background:#3b82f6;color:white;border-color:#3b82f6}
    .step.done {background:#22c55e;color:white;border-color:#22c55e}
    
    .main {flex:1;display:flex;gap:1rem;padding:1rem}
    .left-panel {flex:1;display:flex;flex-direction:column;gap:1rem}
    .right-panel {width:400px;display:flex;flex-direction:column;gap:1rem}
    
    .card {background:#1e293b;border:1px solid #334155;border-radius:8px;padding:1rem}
    .card h2 {font-size:1.1rem;margin-bottom:0.5rem}
    
    .map-container {height:300px;background:#0f172a;border-radius:8px;position:relative;overflow:hidden}
    #leaflet-map {height:100%;width:100%;border-radius:8px}
    
    .kpis {display:grid;grid-template-columns:repeat(5,1fr);gap:0.5rem;margin-top:0.5rem}
    .kpi {background:#0f172a;padding:0.5rem;border-radius:6px;text-align:center}
    .kpi-value {font-size:1.5rem;font-weight:bold}
    .kpi-label {font-size:0.75rem;color:#94a3b8}
    
    .form-row {margin-bottom:0.75rem}
    .form-row label {display:block;font-size:0.85rem;color:#94a3b8;margin-bottom:0.25rem}
    .form-row input, .form-row select {width:100%;padding:0.5rem;background:#0f172a;border:1px solid #334155;border-radius:6px;color:#e2e8f0}
    
    .buttons {display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap}
    .btn {padding:0.5rem 1rem;border:none;border-radius:6px;cursor:pointer;font-weight:500}
    .btn-primary {background:#3b82f6;color:white}
    .btn-secondary {background:#475569;color:white}
    .btn-success {background:#22c55e;color:white}
    .btn-danger {background:#ef4444;color:white}
    .btn-warning {background:#f59e0b;color:white}
    .btn:disabled {opacity:0.5;cursor:not-allowed}
    
    .screen {display:none}
    .screen.active {display:block}
    
    .mode-buttons {display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem}
    .mode-btn {padding:0.75rem;border:1px solid #334155;background:#0f172a;color:#e2e8f0;border-radius:6px;cursor:pointer;transition:all 0.2s}
    .mode-btn.active {background:#3b82f6;border-color:#3b82f6;box-shadow:0 0 15px rgba(59,130,246,0.5)}
    .mode-btn:hover {background:#374151}
    
    .info-text {color:#94a3b8;font-size:0.9rem;margin:0.5rem 0}
    
    /* Modal styles */
    .modal {display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000}
    .modal.active {display:flex;align-items:center;justify-content:center}
    .modal-content {background:#1e293b;border-radius:8px;padding:1.5rem;max-width:600px;max-height:80vh;overflow-y:auto;width:90%;z-index:1001}
    .modal-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .modal-header h2 {margin:0}
    .close-btn {background:transparent;border:none;color:#ef4444;font-size:1.5rem;cursor:pointer}
    
    @media (max-width: 768px) {
      .main {flex-direction:column}
      .right-panel {width:100%}
      .kpis {grid-template-columns:repeat(3,1fr)}
      .mode-buttons {grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <div class="brand">üìç Elektronick√° stazka</div>
      <div class="status">
        <span><span class="dot green"></span>Online</span>
        <span><span class="dot" id="gps-status-dot"></span><span id="gps-status">GPS ƒçek√°</span></span>
        <div class="mode-indicator" id="mode-indicator">P≈ôipraven</div>
        <span id="time">--:--:--</span>
      </div>
    </div>
    <div class="steps">
      <div class="step active" id="step-1">1. √övod</div>
      <div class="step" id="step-2">2. ≈òidiƒç</div>
      <div class="step" id="step-3">3. Start</div>
      <div class="step" id="step-4">4. J√≠zda</div>
      <div class="step" id="step-5">5. Konec</div>
      <div class="step" id="step-6">6. Sum√°≈ô</div>
    </div>
  </div>

  <div class="main">
    <div class="left-panel">
      <div class="card">
        <h2>Mapa a trasa</h2>
        <div class="map-container">
          <div id="leaflet-map"></div>
        </div>
        <div class="kpis">
          <div class="kpi">
            <div class="kpi-value" id="speed">0</div>
            <div class="kpi-label">km/h</div>
          </div>
          <div class="kpi">
            <div class="kpi-value" id="distance">0.0</div>
            <div class="kpi-label">km</div>
          </div>
          <div class="kpi">
            <div class="kpi-value" id="odometer">0</div>
            <div class="kpi-label">tachometr</div>
          </div>
          <div class="kpi">
            <div class="kpi-value" id="fuel-level">0</div>
            <div class="kpi-label">PHM (l)</div>
          </div>
          <div class="kpi">
            <div class="kpi-value" id="duration">0:00</div>
            <div class="kpi-label">ƒças j√≠zdy</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h2>Stav a ovl√°d√°n√≠</h2>
        <div class="form-row">
          <label>GPS sou≈ôadnice</label>
          <input type="text" id="gps-coords" disabled value="ƒåek√° na GPS...">
        </div>
        <div class="buttons">
          <button class="btn btn-primary" id="btn-gps">Aktivovat GPS</button>
          <button class="btn btn-warning" id="btn-simulate">Simulace</button>
          <button class="btn btn-secondary" id="btn-saved-trips">Ulo≈æen√© stazky</button>
          <button class="btn btn-secondary" onclick="exportToJSON()">Export JSON</button>
          <button class="btn btn-secondary" onclick="exportToCSV()">Export CSV</button>
          <button class="btn btn-danger" id="btn-end-trip" onclick="goToStep(5)" disabled>Ukonƒçit stazku</button>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <!-- Screen 1: Intro -->
      <div class="card screen active" id="screen-1">
        <h2>V√≠tejte</h2>
        <p class="info-text">Syst√©m pro evidenci j√≠zd a stazek. Pro start aktivujte GPS nebo pou≈æijte simulaci.</p>
        <div class="buttons">
          <button class="btn btn-primary" onclick="goToStep(2)">Nov√° stazka</button>
          <button class="btn btn-secondary" onclick="showSavedTrips()">Zobrazit ulo≈æen√©</button>
        </div>
      </div>

      <!-- Screen 2: Driver -->
      <div class="card screen" id="screen-2">
        <h2>√ödaje o ≈ôidiƒçi</h2>
        <div class="form-row">
          <label>Jm√©no ≈ôidiƒçe</label>
          <input type="text" id="driver-name" placeholder="Jan Nov√°k">
        </div>
        <div class="form-row">
          <label>ID ≈ôidiƒçe</label>
          <input type="text" id="driver-id" placeholder="12345">
        </div>
        <div class="form-row">
          <label>RZ vozidla</label>
          <input type="text" id="vehicle-plate" placeholder="1A2 3456">
        </div>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="goToStep(1)">Zpƒõt</button>
          <button class="btn btn-primary" onclick="saveDriver()">Pokraƒçovat</button>
        </div>
      </div>

      <!-- Screen 3: Trip Start -->
      <div class="card screen" id="screen-3">
        <h2>Zah√°jen√≠ stazky</h2>
        <div class="form-row">
          <label>ƒå√≠slo stazky</label>
          <input type="number" id="trip-number" value="1">
        </div>
        <div class="form-row">
          <label>Start m√≠sto</label>
          <input type="text" id="start-place" placeholder="Naƒçte se z GPS">
        </div>
        <div class="form-row">
          <label>Tachometr (km)</label>
          <input type="number" id="start-odo" value="0">
        </div>
        <div class="form-row">
          <label>PHM p≈ôi startu (l)</label>
          <input type="number" id="start-fuel" value="0" step="0.1">
        </div>
        <div class="form-row">
          <label>N√°klad</label>
          <input type="text" id="cargo" placeholder="Popis n√°kladu">
        </div>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="goToStep(2)">Zpƒõt</button>
          <button class="btn btn-success" onclick="startTrip()">Zah√°jit stazku</button>
        </div>
      </div>

      <!-- Screen 4: Driving -->
      <div class="card screen" id="screen-4">
        <h2>Re≈æim j√≠zdy</h2>
        <p class="info-text">Vyberte aktu√°ln√≠ ƒçinnost:</p>
        <div class="mode-buttons">
          <button class="mode-btn" data-mode="driving" onclick="setMode('driving')">üöõ J√≠zda</button>
          <button class="mode-btn" data-mode="loading" onclick="setMode('loading')">üì¶ Nakl√°dka</button>
          <button class="mode-btn" data-mode="unloading" onclick="setMode('unloading')">üì§ Vykl√°dka</button>
          <button class="mode-btn" data-mode="fueling" onclick="setMode('fueling')">‚õΩ Tankov√°n√≠</button>
          <button class="mode-btn" data-mode="repair" onclick="setMode('repair')">üîß Oprava</button>
          <button class="mode-btn" data-mode="break" onclick="setMode('break')">‚òï P≈ôest√°vka</button>
        </div>
        <div class="info-text" id="trip-info" style="margin-top:1rem"></div>
        <div class="buttons">
          <button class="btn btn-warning" onclick="pauseTrip()">Pozastavit</button>
          <button class="btn btn-danger" onclick="goToStep(5)">Ukonƒçit stazku</button>
        </div>
      </div>

      <!-- Screen 5: End -->
      <div class="card screen" id="screen-5">
        <h2>Ukonƒçen√≠ stazky</h2>
        <div class="form-row">
          <label>Koneƒçn√© m√≠sto</label>
          <div style="display:flex;gap:0.5rem">
            <input type="text" id="end-place" placeholder="Naƒçte se z GPS" style="flex:1">
            <button class="btn btn-secondary" onclick="loadCurrentGPS()">Naƒç√≠st GPS</button>
          </div>
        </div>
        <div class="form-row">
          <label>Tachometr (km)</label>
          <input type="number" id="end-odo">
        </div>
        <div class="form-row">
          <label>PHM p≈ôi konci (l)</label>
          <input type="number" id="end-fuel" step="0.1">
        </div>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="goToStep(4)">Zpƒõt</button>
          <button class="btn btn-success" onclick="finishTrip()">Ulo≈æit a zobrazit sum√°≈ô</button>
        </div>
      </div>

      <!-- Screen 6: Summary -->
      <div class="card screen" id="screen-6">
        <h2>Sum√°≈ô stazky</h2>
        <div id="summary-content"></div>
        <div class="buttons">
          <button class="btn btn-primary" onclick="newTrip()">Nov√° stazka</button>
          <button class="btn btn-secondary" onclick="showSavedTrips()">Zobrazit ulo≈æen√©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for stop detection - only shows in driving mode -->
  <div class="modal" id="stop-modal">
    <div class="modal-content" style="border:2px solid #f59e0b">
      <div class="modal-header">
        <h2>‚ö†Ô∏è Vozidlo stoj√≠ d√©le ne≈æ 10 sekund</h2>
        <button class="close-btn" onclick="closeStopModal()">&times;</button>
      </div>
      <p class="info-text">Vyberte d≈Øvod zastaven√≠ nebo zav≈ôete pro pokraƒçov√°n√≠ v j√≠zdƒõ:</p>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem;margin-top:1rem">
        <button class="btn btn-primary" onclick="handleStop('loading')">üì¶ Nakl√°dka</button>
        <button class="btn btn-primary" onclick="handleStop('unloading')">üì§ Vykl√°dka</button>
        <button class="btn btn-primary" onclick="handleStop('fueling')">‚õΩ Tankov√°n√≠</button>
        <button class="btn btn-primary" onclick="handleStop('repair')">üîß Oprava</button>
        <button class="btn btn-primary" onclick="handleStop('break')">‚òï P≈ôest√°vka</button>
        <button class="btn btn-primary" onclick="handleStop('idle')">‚è∏Ô∏è Prostoj</button>
      </div>
      <div class="buttons" style="margin-top:1rem">
        <button class="btn btn-secondary" onclick="closeStopModal()">Ignorovat - pokraƒçovat v j√≠zdƒõ</button>
      </div>
    </div>
  </div>

  <!-- Modal for saved trips -->
  <div class="modal" id="trips-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Ulo≈æen√© stazky</h2>
        <button class="close-btn" onclick="closeSavedTrips()">&times;</button>
      </div>
      <div id="trip-list"></div>
    </div>
  </div>

  <script>
    // State management
    let state = {
      currentStep: 1,
      tripActive: false,
      tripData: {},
      currentMode: 'idle',
      currentModeStartTime: null,
      startTime: null,
      odometer: 0,
      distance: 0,
      speed: 0,
      fuelLevel: 0,
      gpsActive: false,
      gpsWatchId: null,
      simulating: false,
      simulationInterval: null,
      lastPosition: null,
      trips: [],
      map: null,
      vehicleMarker: null,
      routePolyline: null,
      routeCoordinates: [],
      // Stop detection - ONLY works in driving mode
      stopDetection: {
        stopTime: 0,
        stopModalShown: false,
        checkInterval: null,
        enabled: false
      },
      modeHistory: [],
      borderCrossings: [],
      europeanCountries: {
        'Czech Republic': {north: 51.06, south: 48.55, east: 18.87, west: 12.10},
        'Germany': {north: 55.06, south: 47.27, east: 15.04, west: 5.87},
        'Austria': {north: 49.02, south: 46.37, east: 17.16, west: 9.53},
        'Poland': {north: 54.84, south: 49.00, east: 24.15, west: 14.12},
        'Slovakia': {north: 49.61, south: 47.73, east: 22.57, west: 16.84}
      },
      lastCountry: null
    };

    // Initialize application
    document.addEventListener('DOMContentLoaded', function() {
      updateClock();
      setInterval(updateClock, 1000);
      loadSavedData();
      loadTrips();
      initializeMap();
      startStopDetection();
      
      // GPS button
      document.getElementById('btn-gps').addEventListener('click', toggleGPS);
      document.getElementById('btn-simulate').addEventListener('click', toggleSimulation);
      document.getElementById('btn-saved-trips').addEventListener('click', showSavedTrips);
      
      if (!navigator.geolocation) {
        document.getElementById('gps-status').textContent = 'GPS nepodporov√°no';
        document.getElementById('btn-gps').disabled = true;
      }
    });

    // Initialize map - simplified version that works
    function initializeMap() {
      state.map = L.map('leaflet-map').setView([50.0755, 14.4378], 13);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(state.map);
      
      const vehicleIcon = L.divIcon({
        html: 'üöõ',
        iconSize: [30, 30],
        className: 'vehicle-marker'
      });
      
      state.vehicleMarker = L.marker([50.0755, 14.4378], {icon: vehicleIcon}).addTo(state.map);
      state.routePolyline = L.polyline([], {color: '#3b82f6', weight: 4, opacity: 0.7}).addTo(state.map);
    }

    function updateClock() {
      document.getElementById('time').textContent = new Date().toLocaleTimeString('cs-CZ');
    }

    // GPS functions - back to working version
    function toggleGPS() {
      if (!state.gpsActive) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            state.gpsActive = true;
            state.lastPosition = position.coords;
            updateGPSDisplay(position.coords);
            updateMapPosition(position.coords.latitude, position.coords.longitude);
            
            state.gpsWatchId = navigator.geolocation.watchPosition(
              (pos) => {
                updatePosition(pos.coords);
              },
              (error) => {
                console.error('GPS error:', error);
                document.getElementById('gps-status').textContent = 'GPS chyba';
              },
              {
                enableHighAccuracy: true,
                maximumAge: 1000,
                timeout: 5000
              }
            );
            
            document.getElementById('btn-gps').textContent = 'Vypnout GPS';
            document.getElementById('gps-status').textContent = 'GPS aktivn√≠';
            document.getElementById('gps-status-dot').className = 'dot green';
          },
          (error) => {
            alert('GPS p≈ô√≠stup zam√≠tnut. Pou≈æijte simulaci.');
            console.error('GPS error:', error);
          }
        );
      } else {
        if (state.gpsWatchId) {
          navigator.geolocation.clearWatch(state.gpsWatchId);
          state.gpsWatchId = null;
        }
        state.gpsActive = false;
        document.getElementById('btn-gps').textContent = 'Aktivovat GPS';
        document.getElementById('gps-status').textContent = 'GPS vypnuto';
        document.getElementById('gps-status-dot').className = 'dot red';
      }
    }

    function updatePosition(coords) {
      if (state.lastPosition) {
        const R = 6371;
        const dLat = (coords.latitude - state.lastPosition.latitude) * Math.PI / 180;
        const dLon = (coords.longitude - state.lastPosition.longitude) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(state.lastPosition.latitude * Math.PI / 180) * 
                  Math.cos(coords.latitude * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        if (state.currentMode === 'driving' && state.tripActive) {
          state.distance += distance;
          state.odometer += distance;
          const fuelConsumed = distance * 0.08;
          state.fuelLevel = Math.max(0, state.fuelLevel - fuelConsumed);
        }
      }
      
      if (coords.speed !== null) {
        state.speed = coords.speed * 3.6;
      }
      
      coords.timestamp = Date.now();
      state.lastPosition = coords;
      updateGPSDisplay(coords);
      updateKPIs();
      updateMapPosition(coords.latitude, coords.longitude);
      
      if (state.tripActive) {
        addRoutePoint(coords.latitude, coords.longitude);
        checkBorderCrossing(coords.latitude, coords.longitude);
      }
      
      // Auto-switch to driving when moving >10 km/h
      if (state.speed > 10 && state.tripActive && state.currentMode !== 'driving') {
        closeStopModal();
        setMode('driving');
      }
    }

    function updateMapPosition(lat, lng) {
      if (state.vehicleMarker) {
        state.vehicleMarker.setLatLng([lat, lng]);
        state.map.panTo([lat, lng]);
      }
    }

    function addRoutePoint(lat, lng) {
      state.routeCoordinates.push([lat, lng]);
      state.routePolyline.setLatLngs(state.routeCoordinates);
    }

    function clearRoute() {
      state.routeCoordinates = [];
      state.routePolyline.setLatLngs([]);
    }

    function updateGPSDisplay(coords) {
      document.getElementById('gps-coords').value = 
        `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;
      
      if (state.currentStep === 3) {
        document.getElementById('start-place').value = 
          `GPS: ${coords.latitude.toFixed(4)}, ${coords.longitude.toFixed(4)}`;
      } else if (state.currentStep === 5) {
        document.getElementById('end-place').value = 
          `GPS: ${coords.latitude.toFixed(4)}, ${coords.longitude.toFixed(4)}`;
      }
    }

    // Simulation
    function toggleSimulation() {
      state.simulating = !state.simulating;
      
      if (state.simulating) {
        if (state.gpsActive) toggleGPS();
        
        document.getElementById('btn-simulate').textContent = 'Zastavit simulaci';
        document.getElementById('gps-status').textContent = 'Simulace aktivn√≠';
        document.getElementById('gps-status-dot').className = 'dot yellow';
        
        if (!state.lastPosition) {
          state.lastPosition = {
            latitude: 50.0755,
            longitude: 14.4378
          };
        }
        
        state.simulationInterval = setInterval(() => {
          if (state.tripActive && state.currentMode === 'driving') {
            state.lastPosition.latitude += (Math.random() - 0.5) * 0.001;
            state.lastPosition.longitude += (Math.random() - 0.5) * 0.001;
            state.speed = 30 + Math.random() * 50;
            const kmPerSecond = state.speed / 3600;
            state.distance += kmPerSecond;
            state.odometer += kmPerSecond;
            const fuelConsumed = kmPerSecond * 0.08;
            state.fuelLevel = Math.max(0, state.fuelLevel - fuelConsumed);
            
            updateGPSDisplay(state.lastPosition);
            updateMapPosition(state.lastPosition.latitude, state.lastPosition.longitude);
            addRoutePoint(state.lastPosition.latitude, state.lastPosition.longitude);
          } else {
            state.speed = 0;
          }
          updateKPIs();
        }, 1000);
      } else {
        document.getElementById('btn-simulate').textContent = 'Simulace';
        document.getElementById('gps-status').textContent = 'Simulace vypnuta';
        document.getElementById('gps-status-dot').className = 'dot red';
        
        if (state.simulationInterval) {
          clearInterval(state.simulationInterval);
          state.simulationInterval = null;
        }
        state.speed = 0;
        updateKPIs();
      }
    }

    function updateKPIs() {
      document.getElementById('speed').textContent = Math.round(state.speed);
      document.getElementById('distance').textContent = state.distance.toFixed(1);
      document.getElementById('odometer').textContent = Math.round(state.odometer);
      document.getElementById('fuel-level').textContent = state.fuelLevel.toFixed(1);
      
      if (state.startTime) {
        const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        document.getElementById('duration').textContent = 
          `${hours}:${minutes.toString().padStart(2, '0')}`;
      }
    }

    // Mode management
    function setMode(mode) {
      const previousMode = state.currentMode;
      const now = new Date();
      
      // Record duration of previous mode
      if (state.currentModeStartTime && previousMode !== 'idle') {
        const duration = now - state.currentModeStartTime;
        state.modeHistory.push({
          mode: previousMode,
          startTime: state.currentModeStartTime,
          endTime: now,
          duration: duration,
          gps: state.lastPosition ? {
            lat: state.lastPosition.latitude,
            lng: state.lastPosition.longitude
          } : null
        });
      }
      
      state.currentMode = mode;
      state.currentModeStartTime = now;
      
      // Update stop detection - ONLY enabled for driving mode
      state.stopDetection.enabled = (mode === 'driving' && state.tripActive);
      
      if (!state.stopDetection.enabled) {
        state.stopDetection.stopTime = 0;
        if (state.stopDetection.stopModalShown) {
          closeStopModal();
        }
      }
      
      updateModeIndicator(mode);
      updateModeButtons(mode);
    }

    function updateModeIndicator(mode) {
      const indicator = document.getElementById('mode-indicator');
      const modeNames = {
        'driving': 'J√≠zda',
        'loading': 'Nakl√°dka', 
        'unloading': 'Vykl√°dka',
        'fueling': 'Tankov√°n√≠',
        'repair': 'Oprava',
        'break': 'P≈ôest√°vka',
        'idle': 'Prostoj'
      };
      
      indicator.textContent = modeNames[mode] || mode;
      indicator.className = `mode-indicator ${mode}`;
    }

    function updateModeButtons(mode) {
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.mode === mode) {
          btn.classList.add('active');
        }
      });
    }

    // Stop detection - ONLY works in driving mode
    function startStopDetection() {
      state.stopDetection.checkInterval = setInterval(() => {
        // ONLY check stops when in driving mode AND trip is active
        if (state.stopDetection.enabled && state.currentMode === 'driving' && state.tripActive) {
          if (state.speed < 5) {
            state.stopDetection.stopTime++;
            if (state.stopDetection.stopTime >= 10 && !state.stopDetection.stopModalShown) {
              showStopModal();
            }
          } else {
            if (state.stopDetection.stopModalShown) {
              closeStopModal();
            }
            state.stopDetection.stopTime = 0;
          }
        } else {
          // Reset when not in driving mode
          state.stopDetection.stopTime = 0;
          if (state.stopDetection.stopModalShown) {
            closeStopModal();
          }
        }
      }, 1000);
    }

    function showStopModal() {
      state.stopDetection.stopModalShown = true;
      document.getElementById('stop-modal').classList.add('active');
    }

    function closeStopModal() {
      state.stopDetection.stopModalShown = false;
      state.stopDetection.stopTime = 0;
      document.getElementById('stop-modal').classList.remove('active');
    }

    function handleStop(reason) {
      setMode(reason);
      closeStopModal();
    }

    // Border crossing detection
    function checkBorderCrossing(lat, lng) {
      if (!state.tripActive) return;
      
      const currentCountry = detectCountry(lat, lng);
      
      if (currentCountry && currentCountry !== state.lastCountry && state.lastCountry) {
        const crossing = {
          fromCountry: state.lastCountry,
          toCountry: currentCountry,
          timestamp: new Date(),
          gps: {lat, lng},
          speed: state.speed,
          odometer: state.odometer
        };
        
        state.borderCrossings.push(crossing);
        alert(`üöõ P≈ôekroƒçena hranice: ${state.lastCountry} ‚Üí ${currentCountry}`);
      }
      
      if (currentCountry) {
        state.lastCountry = currentCountry;
      }
    }

    function detectCountry(lat, lng) {
      for (const [country, bounds] of Object.entries(state.europeanCountries)) {
        if (lat >= bounds.south && lat <= bounds.north && 
            lng >= bounds.west && lng <= bounds.east) {
          return country;
        }
      }
      return null;
    }

    // Trip management
    function goToStep(step) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(`screen-${step}`).classList.add('active');
      
      document.querySelectorAll('.step').forEach((s, i) => {
        s.classList.remove('active', 'done');
        if (i + 1 < step) s.classList.add('done');
        if (i + 1 === step) s.classList.add('active');
      });
      
      state.currentStep = step;
      
      if (step === 3) {
        prefillTripStart();
      } else if (step === 5) {
        document.getElementById('end-odo').value = Math.round(state.odometer);
        document.getElementById('end-fuel').value = state.fuelLevel.toFixed(1);
        loadCurrentGPS();
      }
    }

    function prefillTripStart() {
      const completedTrips = state.trips.filter(t => t.status === 'completed');
      if (completedTrips.length > 0) {
        const lastTrip = completedTrips[completedTrips.length - 1];
        if (lastTrip.endOdo) {
          document.getElementById('start-odo').value = lastTrip.endOdo;
          state.odometer = lastTrip.endOdo;
        }
        if (lastTrip.endFuel !== undefined) {
          document.getElementById('start-fuel').value = lastTrip.endFuel;
          state.fuelLevel = parseFloat(lastTrip.endFuel) || 0;
        }
      }
      updateKPIs();
    }

    function loadCurrentGPS() {
      if (state.lastPosition) {
        document.getElementById('end-place').value = 
          `GPS: ${state.lastPosition.latitude.toFixed(4)}, ${state.lastPosition.longitude.toFixed(4)}`;
      }
    }

    function saveDriver() {
      const name = document.getElementById('driver-name').value;
      const plate = document.getElementById('vehicle-plate').value;
      
      if (!name || !plate) {
        alert('Vypl≈àte jm√©no ≈ôidiƒçe a RZ vozidla');
        return;
      }
      
      state.tripData.driverName = name;
      state.tripData.driverId = document.getElementById('driver-id').value;
      state.tripData.vehiclePlate = plate;
      
      localStorage.setItem('driverData', JSON.stringify({name, id: state.tripData.driverId, plate}));
      goToStep(3);
    }

    function startTrip() {
      state.tripData.id = Date.now().toString();
      state.tripData.tripNumber = document.getElementById('trip-number').value;
      state.tripData.startPlace = document.getElementById('start-place').value || 'Nezn√°m√© m√≠sto';
      state.tripData.startOdo = parseInt(document.getElementById('start-odo').value) || 0;
      state.tripData.startFuel = parseFloat(document.getElementById('start-fuel').value) || 0;
      state.tripData.cargo = document.getElementById('cargo').value;
      state.tripData.startTime = new Date();
      state.tripData.status = 'active';
      
      state.odometer = state.tripData.startOdo;
      state.fuelLevel = state.tripData.startFuel;
      state.tripActive = true;
      state.startTime = Date.now();
      state.modeHistory = [];
      state.borderCrossings = [];
      state.currentModeStartTime = null;
      
      if (state.lastPosition) {
        state.lastCountry = detectCountry(state.lastPosition.latitude, state.lastPosition.longitude);
      }
      
      document.getElementById('btn-end-trip').disabled = false;
      clearRoute();
      
      if (state.lastPosition) {
        addRoutePoint(state.lastPosition.latitude, state.lastPosition.longitude);
      }
      
      goToStep(4);
      setMode('driving');
      updateTripInfo();
    }

    function updateTripInfo() {
      if (state.tripActive) {
        document.getElementById('trip-info').innerHTML = 
          `<strong>Stazka #${state.tripData.tripNumber}</strong><br>
           Start: ${state.tripData.startPlace}<br>
           ≈òidiƒç: ${state.tripData.driverName}`;
      }
    }

    function pauseTrip() {
      state.tripActive = false;
      saveTrips();
      alert('Stazka pozastavena. M≈Ø≈æete ji obnovit v ulo≈æen√Ωch stazk√°ch.');
      goToStep(1);
    }

    function finishTrip() {
      // Complete final mode duration
      if (state.currentModeStartTime && state.currentMode !== 'idle') {
        const now = new Date();
        const duration = now - state.currentModeStartTime;
        state.modeHistory.push({
          mode: state.currentMode,
          startTime: state.currentModeStartTime,
          endTime: now,
          duration: duration,
          gps: state.lastPosition ? {
            lat: state.lastPosition.latitude,
            lng: state.lastPosition.longitude
          } : null
        });
      }

      state.tripData.endPlace = document.getElementById('end-place').value || 'Nezn√°m√© m√≠sto';
      state.tripData.endOdo = parseInt(document.getElementById('end-odo').value) || state.odometer;
      state.tripData.endFuel = parseFloat(document.getElementById('end-fuel').value) || state.fuelLevel;
      state.tripData.endTime = new Date();
      state.tripData.distance = state.distance;
      state.tripData.status = 'completed';
      state.tripData.modeHistory = [...state.modeHistory];
      state.tripData.borderCrossings = [...state.borderCrossings];
      
      if (state.simulating) toggleSimulation();
      if (state.gpsActive) toggleGPS();
      
      saveTrips();
      generateTripSummary();
      
      state.tripActive = false;
      state.modeHistory = [];
      state.borderCrossings = [];
      state.currentModeStartTime = null;
      document.getElementById('btn-end-trip').disabled = true;
      setMode('idle');
      
      goToStep(6);
    }

    function generateTripSummary() {
      // Calculate time spent in each mode
      const modeTimeStats = {};
      let totalTripTime = 0;
      
      state.modeHistory.forEach(entry => {
        const mode = entry.mode;
        const duration = entry.duration || 0;
        if (!modeTimeStats[mode]) modeTimeStats[mode] = 0;
        modeTimeStats[mode] += duration;
        totalTripTime += duration;
      });

      function formatDuration(ms) {
        const minutes = Math.floor(ms / 60000);
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
      }

      let modeSummary = '<p><strong>ƒåasov√Ω rozpad aktivit:</strong></p><ul>';
      const modeNames = {
        'driving': 'J√≠zda',
        'loading': 'Nakl√°dka', 
        'unloading': 'Vykl√°dka',
        'fueling': 'Tankov√°n√≠',
        'repair': 'Oprava',
        'break': 'P≈ôest√°vka'
      };
      
      Object.entries(modeTimeStats).forEach(([mode, duration]) => {
        if (duration > 0) {
          const modeName = modeNames[mode] || mode;
          const percentage = totalTripTime > 0 ? ((duration / totalTripTime) * 100).toFixed(1) : '0';
          modeSummary += `<li>${modeName}: ${formatDuration(duration)} (${percentage}%)</li>`;
        }
      });
      modeSummary += '</ul>';

      let borderSummary = '';
      if (state.borderCrossings.length > 0) {
        borderSummary = '<p><strong>P≈ôekroƒçen√≠ hranic:</strong></p><ul>';
        state.borderCrossings.forEach(crossing => {
          borderSummary += `<li>üåç ${crossing.fromCountry} ‚Üí ${crossing.toCountry}<br>
                           GPS: ${crossing.gps.lat.toFixed(4)}, ${crossing.gps.lng.toFixed(4)}<br>
                           ƒåas: ${crossing.timestamp.toLocaleString('cs-CZ')}</li>`;
        });
        borderSummary += '</ul>';
      }

      const fuelConsumed = state.tripData.startFuel - state.tripData.endFuel;
      
      const summary = `
        <div style="line-height: 1.6">
          <p><strong>Stazka ƒç.:</strong> ${state.tripData.tripNumber}</p>
          <p><strong>≈òidiƒç:</strong> ${state.tripData.driverName}</p>
          <p><strong>Vozidlo:</strong> ${state.tripData.vehiclePlate}</p>
          <p><strong>Trasa:</strong> ${state.tripData.startPlace} ‚Üí ${state.tripData.endPlace}</p>
          <p><strong>Vzd√°lenost:</strong> ${state.distance.toFixed(1)} km</p>
          <p><strong>Tachometr:</strong> ${state.tripData.startOdo} ‚Üí ${state.tripData.endOdo} km</p>
          <p><strong>PHM:</strong> ${state.tripData.startFuel}l ‚Üí ${state.tripData.endFuel.toFixed(1)}l (spot≈ôeba: ${fuelConsumed.toFixed(1)}l)</p>
          <p><strong>ƒåas:</strong> ${state.tripData.startTime.toLocaleString('cs-CZ')} - ${state.tripData.endTime.toLocaleString('cs-CZ')}</p>
          <p><strong>Celkov√° doba:</strong> ${formatDuration(totalTripTime)}</p>
          <p><strong>N√°klad:</strong> ${state.tripData.cargo || '-'}</p>
          ${modeSummary}
          ${borderSummary}
        </div>
      `;
      
      document.getElementById('summary-content').innerHTML = summary;
    }

    function newTrip() {
      state.distance = 0;
      state.tripData = {};
      setMode('idle');
      document.getElementById('distance').textContent = '0.0';
      document.getElementById('speed').textContent = '0';
      document.getElementById('duration').textContent = '0:00';
      clearRoute();
      goToStep(2);
    }

    // Export functions
    function exportToJSON() {
      const data = {
        trips: state.trips.map(trip => ({
          ...trip,
          modeHistory: trip.modeHistory || [],
          borderCrossings: trip.borderCrossings || []
        }))
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `stazky_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }

    function exportToCSV() {
      let csv = 'ƒå√≠slo stazky,≈òidiƒç,Vozidlo,Start m√≠sto,Konec m√≠sto,Vzd√°lenost km,Start tachometr,Konec tachometr,Start PHM,Konec PHM,Start ƒças,Konec ƒças,Aktivita,Doba,GPS Lat,GPS Lng,Hranice z,Hranice do\n';
      
      state.trips.forEach(trip => {
        const baseRow = `${trip.tripNumber},${trip.driverName},${trip.vehiclePlate},${trip.startPlace},${trip.endPlace || ''},${(trip.distance || 0).toFixed(1)},${trip.startOdo || 0},${trip.endOdo || 0},${trip.startFuel || 0},${trip.endFuel || 0},${trip.startTime},${trip.endTime || ''}`;
        
        let hasOperations = false;
        
        if (trip.modeHistory && trip.modeHistory.length > 0) {
          trip.modeHistory.forEach(mode => {
            hasOperations = true;
            const durationMin = Math.round((mode.duration || 0) / 60000);
            csv += `${baseRow},${mode.mode},${durationMin} min,${mode.gps ? mode.gps.lat : ''},${mode.gps ? mode.gps.lng : ''},,\n`;
          });
        }
        
        if (trip.borderCrossings && trip.borderCrossings.length > 0) {
          trip.borderCrossings.forEach(crossing => {
            hasOperations = true;
            csv += `${baseRow},border_crossing,,${crossing.gps.lat},${crossing.gps.lng},${crossing.fromCountry},${crossing.toCountry}\n`;
          });
        }
        
        if (!hasOperations) {
          csv += `${baseRow},-,-,,,\n`;
        }
      });
      
      const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `stazky_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    // Saved trips management
    function loadTrips() {
      state.trips = JSON.parse(localStorage.getItem('trips') || '[]');
    }

    function saveTrips() {
      if (state.tripData.id) {
        const existingIndex = state.trips.findIndex(t => t.id === state.tripData.id);
        if (existingIndex >= 0) {
          state.trips[existingIndex] = state.tripData;
        } else {
          state.trips.push(state.tripData);
        }
      }
      localStorage.setItem('trips', JSON.stringify(state.trips));
    }

    function showSavedTrips() {
      loadTrips();
      const modal = document.getElementById('trips-modal');
      const list = document.getElementById('trip-list');
      
      if (state.trips.length === 0) {
        list.innerHTML = '<p class="info-text">≈Ω√°dn√© ulo≈æen√© stazky</p>';
      } else {
        list.innerHTML = state.trips.map(trip => `
          <div style="background:#0f172a;border:1px solid #334155;border-radius:6px;padding:1rem;margin-bottom:0.5rem">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
              <div style="font-weight:bold">Stazka #${trip.tripNumber}</div>
              <div style="padding:0.2rem 0.5rem;border-radius:4px;font-size:0.75rem;background:${trip.status === 'active' ? '#22c55e' : '#3b82f6'};color:white">${trip.status === 'active' ? 'Aktivn√≠' : 'Dokonƒçena'}</div>
            </div>
            <div style="font-size:0.85rem;color:#94a3b8;line-height:1.4">
              ≈òidiƒç: ${trip.driverName}<br>
              Vozidlo: ${trip.vehiclePlate}<br>
              Trasa: ${trip.startPlace} ${trip.endPlace ? '‚Üí ' + trip.endPlace : ''}<br>
              Vzd√°lenost: ${trip.distance ? trip.distance.toFixed(1) : '0'} km<br>
              Datum: ${new Date(trip.startTime).toLocaleDateString('cs-CZ')}
            </div>
            <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
              <button class="btn btn-secondary" onclick="viewTrip('${trip.id}')">Zobrazit</button>
              <button class="btn btn-danger" onclick="deleteTrip('${trip.id}')">Smazat</button>
            </div>
          </div>
        `).join('');
      }
      
      modal.classList.add('active');
    }

    function closeSavedTrips() {
      document.getElementById('trips-modal').classList.remove('active');
    }

    function viewTrip(tripId) {
      const trip = state.trips.find(t => t.id === tripId);
      if (!trip) return;
      
      state.tripData = trip;
      state.modeHistory = trip.modeHistory || [];
      state.borderCrossings = trip.borderCrossings || [];
      
      generateTripSummary();
      closeSavedTrips();
      goToStep(6);
    }

    function deleteTrip(tripId) {
      if (!confirm('Opravdu chcete smazat tuto stazku?')) return;
      state.trips = state.trips.filter(t => t.id !== tripId);
      localStorage.setItem('trips', JSON.stringify(state.trips));
      showSavedTrips();
    }

    function loadSavedData() {
      const driverData = JSON.parse(localStorage.getItem('driverData') || '{}');
      if (driverData.name) {
        document.getElementById('driver-name').value = driverData.name;
        document.getElementById('driver-id').value = driverData.id || '';
        document.getElementById('vehicle-plate').value = driverData.plate || '';
      }
      
      loadTrips();
      const maxTripNumber = Math.max(0, ...state.trips.map(t => parseInt(t.tripNumber) || 0));
      document.getElementById('trip-number').value = maxTripNumber + 1;
    }

    // Auto-update KPIs
    setInterval(() => {
      if (state.tripActive) {
        updateKPIs();
      }
    }, 1000);
  </script>
</body>
</html>
