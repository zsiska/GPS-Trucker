<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Elektronick√° stazka</title>
  <style>
    * {margin:0;padding:0;box-sizing:border-box}
    body {font-family:system-ui,-apple-system,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;display:flex;flex-direction:column}
    
    .header {padding:1rem;background:#1e293b;border-bottom:1px solid #334155}
    .header-top {display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
    .brand {font-size:1.2rem;font-weight:bold}
    .status {display:flex;gap:1rem;font-size:0.9rem;color:#94a3b8}
    .dot {width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:0.3rem}
    .dot.green {background:#22c55e}
    .dot.yellow {background:#f59e0b}
    .dot.red {background:#ef4444}
    
    .steps {display:flex;gap:0.5rem;flex-wrap:wrap}
    .step {padding:0.3rem 0.6rem;border:1px solid #334155;border-radius:20px;font-size:0.85rem;color:#94a3b8}
    .step.active {background:#3b82f6;color:white;border-color:#3b82f6}
    .step.done {background:#22c55e;color:white;border-color:#22c55e}
    
    .main {flex:1;display:flex;gap:1rem;padding:1rem}
    .left-panel {flex:1;display:flex;flex-direction:column;gap:1rem}
    .right-panel {width:400px;display:flex;flex-direction:column;gap:1rem}
    
    .card {background:#1e293b;border:1px solid #334155;border-radius:8px;padding:1rem}
    .card h2 {font-size:1.1rem;margin-bottom:0.5rem}
    
    .map-container {height:300px;background:#0f172a;border-radius:8px;position:relative;overflow:hidden}
    .vehicle-icon {position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:24px;z-index:10}
    .route-dot {position:absolute;width:4px;height:4px;background:#3b82f6;border-radius:50%;opacity:0.7}
    
    .kpis {display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;margin-top:0.5rem}
    .kpi {background:#0f172a;padding:0.5rem;border-radius:6px;text-align:center}
    .kpi-value {font-size:1.5rem;font-weight:bold}
    .kpi-label {font-size:0.75rem;color:#94a3b8}
    
    .form-row {margin-bottom:0.75rem}
    .form-row label {display:block;font-size:0.85rem;color:#94a3b8;margin-bottom:0.25rem}
    .form-row input, .form-row select {width:100%;padding:0.5rem;background:#0f172a;border:1px solid #334155;border-radius:6px;color:#e2e8f0}
    
    .buttons {display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap}
    .btn {padding:0.5rem 1rem;border:none;border-radius:6px;cursor:pointer;font-weight:500}
    .btn-primary {background:#3b82f6;color:white}
    .btn-secondary {background:#475569;color:white}
    .btn-success {background:#22c55e;color:white}
    .btn-danger {background:#ef4444;color:white}
    .btn-warning {background:#f59e0b;color:white}
    .btn:disabled {opacity:0.5;cursor:not-allowed}
    
    .screen {display:none}
    .screen.active {display:block}
    
    .mode-buttons {display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem}
    .mode-btn {padding:0.75rem;border:1px solid #334155;background:#0f172a;color:#e2e8f0;border-radius:6px;cursor:pointer}
    .mode-btn.active {background:#3b82f6;border-color:#3b82f6}
    
    .info-text {color:#94a3b8;font-size:0.9rem;margin:0.5rem 0}
    
    /* Modal styles */
    .modal {display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:100}
    .modal.active {display:flex;align-items:center;justify-content:center}
    .modal-content {background:#1e293b;border-radius:8px;padding:1.5rem;max-width:600px;max-height:80vh;overflow-y:auto;width:90%}
    .modal-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .modal-header h2 {margin:0}
    .close-btn {background:transparent;border:none;color:#ef4444;font-size:1.5rem;cursor:pointer}
    
    /* Trip list styles */
    .trip-list {max-height:400px;overflow-y:auto}
    .trip-item {background:#0f172a;border:1px solid #334155;border-radius:6px;padding:1rem;margin-bottom:0.5rem}
    .trip-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
    .trip-title {font-weight:bold}
    .trip-status {padding:0.2rem 0.5rem;border-radius:4px;font-size:0.75rem}
    .trip-status.active {background:#22c55e;color:white}
    .trip-status.completed {background:#3b82f6;color:white}
    .trip-details {font-size:0.85rem;color:#94a3b8;line-height:1.4}
    .trip-actions {display:flex;gap:0.5rem;margin-top:0.5rem}
    
    @media (max-width: 768px) {
      .main {flex-direction:column}
      .right-panel {width:100%}
      .kpis {grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <div class="brand">üìç Elektronick√° stazka</div>
      <div class="status">
        <span><span class="dot green"></span>Online</span>
        <span><span class="dot" id="gps-status-dot"></span><span id="gps-status">GPS ƒçek√°</span></span>
        <span id="time">--:--:--</span>
      </div>
    </div>
    <div class="steps">
      <div class="step active" id="step-1">1. √övod</div>
      <div class="step" id="step-2">2. ≈òidiƒç</div>
      <div class="step" id="step-3">3. Start</div>
      <div class="step" id="step-4">4. J√≠zda</div>
      <div class="step" id="step-5">5. Konec</div>
      <div class="step" id="step-6">6. Sum√°≈ô</div>
    </div>
  </div>

  <div class="main">
    <div class="left-panel">
      <div class="card">
        <h2>Mapa a trasa</h2>
        <div class="map-container" id="map">
          <div class="vehicle-icon" id="vehicle">üöõ</div>
        </div>
        <div class="kpis">
          <div class="kpi">
            <div class="kpi-value" id="speed">0</div>
            <div class="kpi-label">km/h</div>
          </div>
          <div class="kpi">
            <div class="kpi-value" id="distance">0.0</div>
            <div class="kpi-label">km</div>
          </div>
          <div class="kpi">
            <div class="kpi-value" id="odometer">0</div>
            <div class="kpi-label">tachometr</div>
          </div>
          <div class="kpi">
            <div class="kpi-value" id="duration">0:00</div>
            <div class="kpi-label">ƒças j√≠zdy</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h2>Stav a ovl√°d√°n√≠</h2>
        <div class="form-row">
          <label>Aktu√°ln√≠ re≈æim</label>
          <input type="text" id="current-mode" disabled value="P≈ôipraven">
        </div>
        <div class="form-row">
          <label>GPS sou≈ôadnice</label>
          <input type="text" id="gps-coords" disabled value="ƒåek√° na GPS...">
        </div>
        <div class="buttons">
          <button class="btn btn-primary" id="btn-gps">Aktivovat GPS</button>
          <button class="btn btn-warning" id="btn-simulate">Simulace</button>
          <button class="btn btn-secondary" id="btn-saved-trips">Ulo≈æen√© stazky</button>
          <button class="btn btn-danger" id="btn-end-trip" disabled>Ukonƒçit stazku</button>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <!-- Screen 1: Intro -->
      <div class="card screen active" id="screen-1">
        <h2>V√≠tejte</h2>
        <p class="info-text">Syst√©m pro evidenci j√≠zd a stazek. Pro start aktivujte GPS nebo pou≈æijte simulaci.</p>
        <div class="buttons">
          <button class="btn btn-primary" onclick="goToStep(2)">Nov√° stazka</button>
          <button class="btn btn-secondary" onclick="showSavedTrips()">Zobrazit ulo≈æen√©</button>
        </div>
      </div>

      <!-- Screen 2: Driver -->
      <div class="card screen" id="screen-2">
        <h2>√ödaje o ≈ôidiƒçi</h2>
        <div class="form-row">
          <label>Jm√©no ≈ôidiƒçe</label>
          <input type="text" id="driver-name" placeholder="Jan Nov√°k">
        </div>
        <div class="form-row">
          <label>ID ≈ôidiƒçe</label>
          <input type="text" id="driver-id" placeholder="12345">
        </div>
        <div class="form-row">
          <label>RZ vozidla</label>
          <input type="text" id="vehicle-plate" placeholder="1A2 3456">
        </div>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="goToStep(1)">Zpƒõt</button>
          <button class="btn btn-primary" onclick="saveDriver()">Pokraƒçovat</button>
        </div>
      </div>

      <!-- Screen 3: Trip Start -->
      <div class="card screen" id="screen-3">
        <h2>Zah√°jen√≠ stazky</h2>
        <div class="form-row">
          <label>ƒå√≠slo stazky</label>
          <input type="number" id="trip-number" value="1">
        </div>
        <div class="form-row">
          <label>Start m√≠sto</label>
          <input type="text" id="start-place" placeholder="Naƒçte se z GPS">
        </div>
        <div class="form-row">
          <label>Tachometr (km)</label>
          <input type="number" id="start-odo" value="0">
        </div>
        <div class="form-row">
          <label>N√°klad</label>
          <input type="text" id="cargo" placeholder="Popis n√°kladu">
        </div>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="goToStep(2)">Zpƒõt</button>
          <button class="btn btn-success" onclick="startTrip()">Zah√°jit stazku</button>
        </div>
      </div>

      <!-- Screen 4: Driving -->
      <div class="card screen" id="screen-4">
        <h2>Re≈æim j√≠zdy</h2>
        <p class="info-text">Vyberte aktu√°ln√≠ ƒçinnost:</p>
        <div class="mode-buttons">
          <button class="mode-btn" data-mode="driving" onclick="setMode('driving')">üöõ J√≠zda</button>
          <button class="mode-btn" data-mode="loading" onclick="setMode('loading')">üì¶ Nakl√°dka</button>
          <button class="mode-btn" data-mode="unloading" onclick="setMode('unloading')">üì§ Vykl√°dka</button>
          <button class="mode-btn" data-mode="break" onclick="setMode('break')">‚òï P≈ôest√°vka</button>
        </div>
        <div class="info-text" id="trip-info" style="margin-top:1rem"></div>
        <div class="buttons">
          <button class="btn btn-warning" onclick="pauseTrip()">Pozastavit</button>
          <button class="btn btn-danger" onclick="goToStep(5)">Ukonƒçit stazku</button>
        </div>
      </div>

      <!-- Screen 5: End -->
      <div class="card screen" id="screen-5">
        <h2>Ukonƒçen√≠ stazky</h2>
        <div class="form-row">
          <label>Koneƒçn√© m√≠sto</label>
          <input type="text" id="end-place" placeholder="Naƒçte se z GPS">
        </div>
        <div class="form-row">
          <label>Tachometr (km)</label>
          <input type="number" id="end-odo">
        </div>
        <div class="form-row">
          <label>Palivo (l)</label>
          <input type="number" id="fuel" step="0.1">
        </div>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="goToStep(4)">Zpƒõt</button>
          <button class="btn btn-success" onclick="finishTrip()">Ulo≈æit a zobrazit sum√°≈ô</button>
        </div>
      </div>

      <!-- Screen 6: Summary -->
      <div class="card screen" id="screen-6">
        <h2>Sum√°≈ô stazky</h2>
        <div id="summary-content"></div>
        <div class="buttons">
          <button class="btn btn-primary" onclick="newTrip()">Nov√° stazka</button>
          <button class="btn btn-secondary" onclick="showSavedTrips()">Zobrazit ulo≈æen√©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for saved trips -->
  <div class="modal" id="trips-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Ulo≈æen√© stazky</h2>
        <button class="close-btn" onclick="closeSavedTrips()">&times;</button>
      </div>
      <div class="trip-list" id="trip-list"></div>
    </div>
  </div>

  <!-- Modal for editing trip -->
  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Upravit stazku</h2>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <div id="edit-form">
        <div class="form-row">
          <label>ƒå√≠slo stazky</label>
          <input type="number" id="edit-trip-number">
        </div>
        <div class="form-row">
          <label>≈òidiƒç</label>
          <input type="text" id="edit-driver-name">
        </div>
        <div class="form-row">
          <label>RZ vozidla</label>
          <input type="text" id="edit-vehicle-plate">
        </div>
        <div class="form-row">
          <label>Start m√≠sto</label>
          <input type="text" id="edit-start-place">
        </div>
        <div class="form-row">
          <label>Konec m√≠sto</label>
          <input type="text" id="edit-end-place">
        </div>
        <div class="form-row">
          <label>N√°klad</label>
          <input type="text" id="edit-cargo">
        </div>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="closeEditModal()">Zru≈°it</button>
          <button class="btn btn-success" onclick="saveEditedTrip()">Ulo≈æit zmƒõny</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State management
    let state = {
      currentStep: 1,
      tripActive: false,
      tripData: {},
      currentMode: 'idle',
      startTime: null,
      odometer: 0,
      distance: 0,
      speed: 0,
      gpsActive: false,
      gpsWatchId: null,
      simulating: false,
      simulationInterval: null,
      lastPosition: null,
      trips: [],
      editingTripId: null,
      pausedTrip: null
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      updateClock();
      setInterval(updateClock, 1000);
      loadSavedData();
      loadTrips();
      
      // Check for GPS support
      if (!navigator.geolocation) {
        document.getElementById('gps-status').textContent = 'GPS nepodporov√°no';
        document.getElementById('btn-gps').disabled = true;
      }
    });

    function updateClock() {
      document.getElementById('time').textContent = new Date().toLocaleTimeString('cs-CZ');
    }

    // GPS functions
    document.getElementById('btn-gps').addEventListener('click', toggleGPS);
    
    function toggleGPS() {
      if (!state.gpsActive) {
        // Request GPS permission and start tracking
        navigator.geolocation.getCurrentPosition(
          (position) => {
            // Success - start watching position
            state.gpsActive = true;
            state.lastPosition = position.coords;
            updateGPSDisplay(position.coords);
            
            state.gpsWatchId = navigator.geolocation.watchPosition(
              (pos) => {
                updatePosition(pos.coords);
              },
              (error) => {
                console.error('GPS error:', error);
                document.getElementById('gps-status').textContent = 'GPS chyba';
              },
              {
                enableHighAccuracy: true,
                maximumAge: 1000,
                timeout: 5000
              }
            );
            
            document.getElementById('btn-gps').textContent = 'Vypnout GPS';
            document.getElementById('gps-status').textContent = 'GPS aktivn√≠';
            document.getElementById('gps-status-dot').className = 'dot green';
          },
          (error) => {
            alert('GPS p≈ô√≠stup zam√≠tnut. Pou≈æijte simulaci.');
            console.error('GPS error:', error);
          }
        );
      } else {
        // Stop GPS tracking
        if (state.gpsWatchId) {
          navigator.geolocation.clearWatch(state.gpsWatchId);
          state.gpsWatchId = null;
        }
        state.gpsActive = false;
        document.getElementById('btn-gps').textContent = 'Aktivovat GPS';
        document.getElementById('gps-status').textContent = 'GPS vypnuto';
        document.getElementById('gps-status-dot').className = 'dot red';
      }
    }

    function updatePosition(coords) {
      if (state.lastPosition) {
        // Calculate distance using Haversine formula
        const R = 6371; // Earth radius in km
        const dLat = (coords.latitude - state.lastPosition.latitude) * Math.PI / 180;
        const dLon = (coords.longitude - state.lastPosition.longitude) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(state.lastPosition.latitude * Math.PI / 180) * 
                  Math.cos(coords.latitude * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        if (state.currentMode === 'driving' && state.tripActive) {
          state.distance += distance;
          state.odometer += distance;
        }
      }
      
      // Update speed
      if (coords.speed !== null) {
        state.speed = coords.speed * 3.6; // Convert m/s to km/h
      }
      
      state.lastPosition = coords;
      updateGPSDisplay(coords);
      updateKPIs();
      
      // Add route dot on map
      if (state.tripActive) {
        addRouteDot(coords);
      }
    }

    function updateGPSDisplay(coords) {
      document.getElementById('gps-coords').value = 
        `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;
      
      // Update start/end place with reverse geocoding (simplified)
      if (state.currentStep === 3) {
        document.getElementById('start-place').value = 
          `GPS: ${coords.latitude.toFixed(4)}, ${coords.longitude.toFixed(4)}`;
      } else if (state.currentStep === 5) {
        document.getElementById('end-place').value = 
          `GPS: ${coords.latitude.toFixed(4)}, ${coords.longitude.toFixed(4)}`;
      }
    }

    function addRouteDot(coords) {
      const map = document.getElementById('map');
      const dot = document.createElement('div');
      dot.className = 'route-dot';
      
      // Simple mapping (would need real map integration for production)
      const x = ((coords.longitude + 180) % 360) / 360 * 100;
      const y = ((90 - coords.latitude) % 180) / 180 * 100;
      
      dot.style.left = x + '%';
      dot.style.top = y + '%';
      map.appendChild(dot);
      
      // Remove old dots if too many
      const dots = map.querySelectorAll('.route-dot');
      if (dots.length > 100) {
        dots[0].remove();
      }
    }

    // Simulation
    document.getElementById('btn-simulate').addEventListener('click', toggleSimulation);
    
    function toggleSimulation() {
      state.simulating = !state.simulating;
      
      if (state.simulating) {
        // Stop real GPS if active
        if (state.gpsActive) {
          toggleGPS();
        }
        
        document.getElementById('btn-simulate').textContent = 'Zastavit simulaci';
        document.getElementById('gps-status').textContent = 'Simulace aktivn√≠';
        document.getElementById('gps-status-dot').className = 'dot yellow';
        
        // Initialize simulated position
        if (!state.lastPosition) {
          state.lastPosition = {
            latitude: 50.0755,
            longitude: 14.4378
          };
        }
        
        state.simulationInterval = setInterval(() => {
          if (state.currentMode === 'driving' && state.tripActive) {
            // Simulate movement
            state.lastPosition.latitude += (Math.random() - 0.5) * 0.0001;
            state.lastPosition.longitude += (Math.random() - 0.5) * 0.0001;
            
            // Simulate speed between 30-80 km/h
            state.speed = 30 + Math.random() * 50;
            const kmPerSecond = state.speed / 3600;
            state.distance += kmPerSecond;
            state.odometer += kmPerSecond;
            
            updateGPSDisplay(state.lastPosition);
            addRouteDot(state.lastPosition);
          } else {
            state.speed = 0;
          }
          
          updateKPIs();
        }, 1000);
      } else {
        document.getElementById('btn-simulate').textContent = 'Simulace';
        document.getElementById('gps-status').textContent = 'Simulace vypnuta';
        document.getElementById('gps-status-dot').className = 'dot red';
        
        if (state.simulationInterval) {
          clearInterval(state.simulationInterval);
          state.simulationInterval = null;
        }
        
        state.speed = 0;
        updateKPIs();
      }
    }

    function updateKPIs() {
      document.getElementById('speed').textContent = Math.round(state.speed);
      document.getElementById('distance').textContent = state.distance.toFixed(1);
      document.getElementById('odometer').textContent = Math.round(state.odometer);
      
      if (state.startTime) {
        const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        document.getElementById('duration').textContent = 
          `${hours}:${minutes.toString().padStart(2, '0')}`;
      }
    }

    // Trip management
    function goToStep(step) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(`screen-${step}`).classList.add('active');
      
      document.querySelectorAll('.step').forEach((s, i) => {
        s.classList.remove('active', 'done');
        if (i + 1 < step) s.classList.add('done');
        if (i + 1 === step) s.classList.add('active');
      });
      
      state.currentStep = step;
      
      if (step === 5) {
        document.getElementById('end-odo').value = Math.round(state.odometer);
      }
    }

    function saveDriver() {
      const name = document.getElementById('driver-name').value;
      const id = document.getElementById('driver-id').value;
      const plate = document.getElementById('vehicle-plate').value;
      
      if (!name || !plate) {
        alert('Vypl≈àte jm√©no ≈ôidiƒçe a RZ vozidla');
        return;
      }
      
      state.tripData.driverName = name;
      state.tripData.driverId = id;
      state.tripData.vehiclePlate = plate;
      
      localStorage.setItem('driverData', JSON.stringify({name, id, plate}));
      goToStep(3);
    }

    function startTrip() {
      state.tripData.id = Date.now().toString();
      state.tripData.tripNumber = document.getElementById('trip-number').value;
      state.tripData.startPlace = document.getElementById('start-place').value || 'Nezn√°m√© m√≠sto';
      state.tripData.startOdo = parseInt(document.getElementById('start-odo').value) || 0;
      state.tripData.cargo = document.getElementById('cargo').value;
      state.tripData.startTime = new Date();
      state.tripData.status = 'active';
      
      state.odometer = state.tripData.startOdo;
      state.tripActive = true;
      state.startTime = Date.now();
      
      document.getElementById('btn-end-trip').disabled = false;
      document.getElementById('current-mode').value = 'J√≠zda zah√°jena';
      
      // Clear map
      document.querySelectorAll('.route-dot').forEach(dot => dot.remove());
      
      goToStep(4);
      setMode('driving');
      updateTripInfo();
    }

    function setMode(mode) {
      state.currentMode = mode;
      
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.mode === mode) {
          btn.classList.add('active');
        }
      });
      
      const modeNames = {
        'driving': 'J√≠zda',
        'loading': 'Nakl√°dka',
        'unloading': 'Vykl√°dka',
        'break': 'P≈ôest√°vka'
      };
      
      document.getElementById('current-mode').value = modeNames[mode] || mode;
    }

    function updateTripInfo() {
      if (state.tripActive) {
        document.getElementById('trip-info').innerHTML = 
          `<strong>Stazka #${state.tripData.tripNumber}</strong><br>
           Start: ${state.tripData.startPlace}<br>
           ≈òidiƒç: ${state.tripData.driverName}`;
      }
    }

    function pauseTrip() {
      state.pausedTrip = {...state.tripData, distance: state.distance, odometer: state.odometer};
      state.tripActive = false;
      saveTrips();
      alert('Stazka pozastavena. M≈Ø≈æete ji obnovit v ulo≈æen√Ωch stazk√°ch.');
      goToStep(1);
    }

    function finishTrip() {
      state.tripData.endPlace = document.getElementById('end-place').value || 'Nezn√°m√© m√≠sto';
      state.tripData.endOdo = parseInt(document.getElementById('end-odo').value) || state.odometer;
      state.tripData.fuel = document.getElementById('fuel').value;
      state.tripData.endTime = new Date();
      state.tripData.distance = state.distance;
      state.tripData.status = 'completed';
      
      // Stop simulation/GPS if running
      if (state.simulating) toggleSimulation();
      if (state.gpsActive) toggleGPS();
      
      // Save trip
      saveTrips();
      
      // Generate summary
      const summary = `
        <div style="line-height: 1.6">
          <p><strong>Stazka ƒç.:</strong> ${state.tripData.tripNumber}</p>
          <p><strong>≈òidiƒç:</strong> ${state.tripData.driverName}</p>
          <p><strong>Vozidlo:</strong> ${state.tripData.vehiclePlate}</p>
          <p><strong>Trasa:</strong> ${state.tripData.startPlace} ‚Üí ${state.tripData.endPlace}</p>
          <p><strong>Vzd√°lenost:</strong> ${state.distance.toFixed(1)} km</p>
          <p><strong>Tachometr:</strong> ${state.tripData.startOdo} ‚Üí ${state.tripData.endOdo} km</p>
          <p><strong>ƒåas:</strong> ${state.tripData.startTime.toLocaleString('cs-CZ')} - ${state.tripData.endTime.toLocaleString('cs-CZ')}</p>
          <p><strong>N√°klad:</strong> ${state.tripData.cargo || '-'}</p>
          <p><strong>Palivo:</strong> ${state.tripData.fuel || '-'} l</p>
        </div>
      `;
      
      document.getElementById('summary-content').innerHTML = summary;
      
      // Reset state
      state.tripActive = false;
      document.getElementById('btn-end-trip').disabled = true;
      
      goToStep(6);
    }

    function newTrip() {
      state.distance = 0;
      state.tripData = {};
      document.getElementById('distance').textContent = '0.0';
      document.getElementById('speed').textContent = '0';
      document.getElementById('duration').textContent = '0:00';
      
      // Clear map
      document.querySelectorAll('.route-dot').forEach(dot => dot.remove());
      
      goToStep(2);
    }

    // Saved trips management
    document.getElementById('btn-saved-trips').addEventListener('click', showSavedTrips);
    
    function loadTrips() {
      state.trips = JSON.parse(localStorage.getItem('trips') || '[]');
    }

    function saveTrips() {
      // Add or update current trip
      if (state.tripData.id) {
        const existingIndex = state.trips.findIndex(t => t.id === state.tripData.id);
        if (existingIndex >= 0) {
          state.trips[existingIndex] = state.tripData;
        } else {
          state.trips.push(state.tripData);
        }
      }
      
      localStorage.setItem('trips', JSON.stringify(state.trips));
    }

    function showSavedTrips() {
      loadTrips();
      const modal = document.getElementById('trips-modal');
      const list = document.getElementById('trip-list');
      
      if (state.trips.length === 0) {
        list.innerHTML = '<p class="info-text">≈Ω√°dn√© ulo≈æen√© stazky</p>';
      } else {
        list.innerHTML = state.trips.map(trip => `
          <div class="trip-item">
            <div class="trip-header">
              <div class="trip-title">Stazka #${trip.tripNumber}</div>
              <div class="trip-status ${trip.status}">${trip.status === 'active' ? 'Aktivn√≠' : 'Dokonƒçena'}</div>
            </div>
            <div class="trip-details">
              ≈òidiƒç: ${trip.driverName}<br>
              Vozidlo: ${trip.vehiclePlate}<br>
              Trasa: ${trip.startPlace} ${trip.endPlace ? '‚Üí ' + trip.endPlace : ''}<br>
              Vzd√°lenost: ${trip.distance ? trip.distance.toFixed(1) : '0'} km<br>
              Datum: ${new Date(trip.startTime).toLocaleDateString('cs-CZ')}
            </div>
            <div class="trip-actions">
              <button class="btn btn-primary" onclick="editTrip('${trip.id}')">Upravit</button>
              ${trip.status === 'active' ? 
                `<button class="btn btn-success" onclick="continueTrip('${trip.id}')">Pokraƒçovat</button>` : 
                `<button class="btn btn-secondary" onclick="viewTrip('${trip.id}')">Zobrazit</button>`
              }
              <button class="btn btn-danger" onclick="deleteTrip('${trip.id}')">Smazat</button>
            </div>
          </div>
        `).join('');
      }
      
      modal.classList.add('active');
    }

    function closeSavedTrips() {
      document.getElementById('trips-modal').classList.remove('active');
    }

    function editTrip(tripId) {
      const trip = state.trips.find(t => t.id === tripId);
      if (!trip) return;
      
      state.editingTripId = tripId;
      
      document.getElementById('edit-trip-number').value = trip.tripNumber;
      document.getElementById('edit-driver-name').value = trip.driverName;
      document.getElementById('edit-vehicle-plate').value = trip.vehiclePlate;
      document.getElementById('edit-start-place').value = trip.startPlace;
      document.getElementById('edit-end-place').value = trip.endPlace || '';
      document.getElementById('edit-cargo').value = trip.cargo || '';
      
      document.getElementById('edit-modal').classList.add('active');
      closeSavedTrips();
    }

    function closeEditModal() {
      document.getElementById('edit-modal').classList.remove('active');
      state.editingTripId = null;
    }

    function saveEditedTrip() {
      if (!state.editingTripId) return;
      
      const trip = state.trips.find(t => t.id === state.editingTripId);
      if (!trip) return;
      
      trip.tripNumber = document.getElementById('edit-trip-number').value;
      trip.driverName = document.getElementById('edit-driver-name').value;
      trip.vehiclePlate = document.getElementById('edit-vehicle-plate').value;
      trip.startPlace = document.getElementById('edit-start-place').value;
      trip.endPlace = document.getElementById('edit-end-place').value;
      trip.cargo = document.getElementById('edit-cargo').value;
      
      localStorage.setItem('trips', JSON.stringify(state.trips));
      
      alert('Stazka byla upravena');
      closeEditModal();
      showSavedTrips();
    }

    function continueTrip(tripId) {
      const trip = state.trips.find(t => t.id === tripId);
      if (!trip || trip.status !== 'active') return;
      
      // Load trip data
      state.tripData = trip;
      state.distance = trip.distance || 0;
      state.odometer = trip.startOdo + state.distance;
      state.startTime = new Date(trip.startTime).getTime();
      state.tripActive = true;
      
      // Load driver data
      document.getElementById('driver-name').value = trip.driverName;
      document.getElementById('driver-id').value = trip.driverId || '';
      document.getElementById('vehicle-plate').value = trip.vehiclePlate;
      
      document.getElementById('btn-end-trip').disabled = false;
      
      closeSavedTrips();
      goToStep(4);
      setMode('driving');
      updateTripInfo();
      
      alert(`Pokraƒçov√°n√≠ ve stazce #${trip.tripNumber}`);
    }

    function viewTrip(tripId) {
      const trip = state.trips.find(t => t.id === tripId);
      if (!trip) return;
      
      const summary = `
        <div style="line-height: 1.6">
          <p><strong>Stazka ƒç.:</strong> ${trip.tripNumber}</p>
          <p><strong>≈òidiƒç:</strong> ${trip.driverName}</p>
          <p><strong>Vozidlo:</strong> ${trip.vehiclePlate}</p>
          <p><strong>Trasa:</strong> ${trip.startPlace} ‚Üí ${trip.endPlace || 'Nedokonƒçeno'}</p>
          <p><strong>Vzd√°lenost:</strong> ${(trip.distance || 0).toFixed(1)} km</p>
          <p><strong>Tachometr:</strong> ${trip.startOdo} ‚Üí ${trip.endOdo || '?'} km</p>
          <p><strong>ƒåas:</strong> ${new Date(trip.startTime).toLocaleString('cs-CZ')} ${trip.endTime ? '- ' + new Date(trip.endTime).toLocaleString('cs-CZ') : ''}</p>
          <p><strong>N√°klad:</strong> ${trip.cargo || '-'}</p>
          <p><strong>Palivo:</strong> ${trip.fuel || '-'} l</p>
        </div>
      `;
      
      document.getElementById('summary-content').innerHTML = summary;
      closeSavedTrips();
      goToStep(6);
    }

    function deleteTrip(tripId) {
      if (!confirm('Opravdu chcete smazat tuto stazku?')) return;
      
      state.trips = state.trips.filter(t => t.id !== tripId);
      localStorage.setItem('trips', JSON.stringify(state.trips));
      
      showSavedTrips();
    }

    function loadSavedData() {
      const driverData = JSON.parse(localStorage.getItem('driverData') || '{}');
      if (driverData.name) {
        document.getElementById('driver-name').value = driverData.name;
        document.getElementById('driver-id').value = driverData.id || '';
        document.getElementById('vehicle-plate').value = driverData.plate || '';
      }
      
      loadTrips();
      const maxTripNumber = Math.max(0, ...state.trips.map(t => parseInt(t.tripNumber) || 0));
      document.getElementById('trip-number').value = maxTripNumber + 1;
    }

    // Auto-update KPIs every second
    setInterval(() => {
      if (state.tripActive) {
        updateKPIs();
      }
    }, 1000);
  </script>
</body>
</html>
