<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elektronick√° stazka ‚Äì demo</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: linear-gradient(135deg,#667eea 0%, #764ba2 100%);
            min-height: 100vh; display:flex; flex-direction:column;
        }
        .header { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-bottom:1px solid rgba(255,255,255,0.2); padding:1rem 1.25rem; color:#fff; }
        .status-bar { display:flex; flex-wrap:wrap; gap:1rem; margin-top:.25rem; font-size:.9rem; }
        .status-item { display:flex; align-items:center; gap:.5rem; }
        .status-dot { width:8px; height:8px; border-radius:50%; animation:pulse 2s infinite; }
        .status-online{background:#4ade80;} .status-gps{background:#3b82f6;} .status-bluetooth{background:#8b5cf6;}
        @keyframes pulse { 0%{opacity:1} 50%{opacity:.5} 100%{opacity:1} }

        .main { display:flex; gap:1rem; padding:1rem; flex:1; }
        .sidebar { width:360px; background:#fffffff2; border-radius:14px; padding:1rem; border:1px solid #e5e7eb; box-shadow: 0 8px 32px rgba(0,0,0,.15); overflow:auto; }
        .content { flex:1; display:flex; flex-direction:column; gap:1rem; }
        .card { background:#ffffffee; border:1px solid #e5e7eb; border-radius:14px; padding:1rem; }
        .map-wrap { height:420px; display:flex; flex-direction:column; gap:.5rem; }
        .map { position:relative; flex:1; background: linear-gradient(45deg,#f0f9ff,#e0f2fe 50%,#f0f9ff); border:2px solid #e0e7ff; border-radius:10px; overflow:hidden; }
        .road { position:absolute; background:#374151; border-radius:2px; }
        .road-h { height:4px; width:100%; top:50%; left:0; }
        .road-v { width:4px; height:100%; left:50%; top:0; }
        .vehicle { position:absolute; width:24px; height:24px; border-radius:50%; border:3px solid #fff; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,.3); z-index:10; }
        .vehicle.driving{ background:#22c55e; } .vehicle.idle{background:#f59e0b;} .vehicle.loading{background:#3b82f6;}
        .vehicle.unloading{background:#1d4ed8;} .vehicle.break{background:#8b5cf6;} .vehicle.maintenance{background:#6b7280;} .vehicle.fuel{background:#ef4444;}
        .route-dot { position:absolute; width:4px; height:4px; border-radius:50%; background:#1d4ed8; opacity:.8; }

        .kpis { display:grid; grid-template-columns: repeat(2,1fr); gap:.75rem; margin-top:.75rem; }
        .kpi { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:.75rem; text-align:center; }
        .kpi .val { font-size:1.6rem; font-weight:800; color:#111827; }
        .kpi .lbl { color:#64748b; font-size:.8rem; }

        .controls { display:grid; gap:.5rem; }
        .row { display:grid; gap:.3rem; }
        label { font-size:.85rem; color:#334155; font-weight:600; }
        input, select, textarea { padding:.55rem .6rem; border:1px solid #cbd5e1; border-radius:8px; background:#fff; font-size:.95rem; }
        .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:.5rem; }
        .btn { padding:.6rem .9rem; border:1px solid #cbd5e1; border-radius:10px; background:#f8fafc; cursor:pointer; font-weight:700; }
        .btn.primary{ background:#0ea5e9; color:#fff; border-color:#0284c7; }
        .btn.danger{ background:#ef4444; color:#fff; border-color:#b91c1c; }
        .btn.ghost{ background:#fff; }
        .actions { display:flex; gap:.5rem; flex-wrap:wrap; }
        .always { position:sticky; bottom:0; padding-top:.75rem; background:linear-gradient(180deg,transparent, #ffffffcc 40%, #ffffffcc); }

        .actions-panel .action-buttons { display:grid; grid-template-columns: repeat(2,1fr); gap:.5rem; }
        .action-btn { padding:.8rem; border:none; border-radius:10px; color:#fff; font-weight:700; background:linear-gradient(135deg,#6b7280,#4b5563); cursor:pointer; }
        .action-btn.active{ background:linear-gradient(135deg,#22c55e,#16a34a); }
        .action-btn.recommended{ background:linear-gradient(135deg,#3b82f6,#1d4ed8); }

        .log { background:#111827; color:#e5e7eb; border:2px solid #374151; border-radius:10px; height:220px; overflow:auto; padding:.75rem; font-family:Consolas, monospace; font-size:.85rem; }
        .log .item{ border-bottom:1px dashed #374151; padding:.25rem 0; }
        .muted{ color:#64748b; }

        /* Modal */
        .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:1000; }
        .modal { width:min(680px, 92vw); background:#fff; border-radius:14px; border:1px solid #e5e7eb; box-shadow:0 10px 40px rgba(0,0,0,.25); padding:1rem; }
        .modal h2{ margin-bottom:.5rem; }
        .modal .grid-2{ grid-template-columns:1fr 1fr; }
        .modal .row.inline { grid-template-columns: 1fr auto; align-items:end; }
        .modal .footer{ display:flex; gap:.5rem; justify-content:flex-end; margin-top:.75rem; }

        /* Toast */
        .toast{ position:fixed; top:16px; right:16px; background:#0ea5e9; color:#fff; padding:.6rem .9rem; border-radius:10px; font-weight:700; transform:translateX(400px); transition:transform .4s; z-index:1200; }
        .toast.show{ transform:translateX(0); }
        .toast.error{ background:#ef4444; } .toast.warn{ background:#f59e0b; } .toast.ok{ background:#22c55e; }

        @media (max-width: 900px) {
            .main{ flex-direction:column; }
            .sidebar{ width:100%; order:2; }
            .actions-panel .action-buttons{ grid-template-columns:1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>Elektronick√° stazka</h1>
            <div class="status-bar">
                <div class="status-item"><div class="status-dot status-online"></div><span id="status-online">Online</span></div>
                <div class="status-item"><div class="status-dot status-gps"></div><span id="status-gps">GPS</span></div>
                <div class="status-item"><span id="status-time"></span></div>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="sidebar">
            <div class="card">
                <h3>≈òidiƒç a vozidlo</h3>
                <div class="controls">
                    <div class="row"><label>≈òidiƒç</label><input id="driverName" placeholder="Jm√©no a p≈ô√≠jmen√≠"></div>
                    <div class="row"><label>ID ≈ôidiƒçe</label><input id="driverId" placeholder="ID / ƒç√≠slo"></div>
                    <div class="row"><label>RZ vozidla</label><input id="vehiclePlate" placeholder="SPZ / RZ"></div>
                </div>
                <div class="kpis">
                    <div class="kpi"><div class="val" id="kpi-speed">0</div><div class="lbl">km/h</div></div>
                    <div class="kpi"><div class="val" id="kpi-odo">0</div><div class="lbl">tachometr km</div></div>
                </div>
            </div>

            <div class="card">
                <h3>Bƒõ≈æ√≠c√≠ stazka</h3>
                <div class="controls">
                    <div class="row"><span class="muted" id="currentTripInfo">≈Ω√°dn√° stazka nebƒõ≈æ√≠</span></div>
                    <div class="row"><label>Aktu√°ln√≠ re≈æim</label><input id="currentMode" disabled></div>
                    <div class="row"><label>GPS</label><input id="currentGps" disabled></div>
                    <div class="row"><label>Ujeto</label><input id="currentDistance" disabled></div>
                </div>
                <div class="always">
                    <button id="endTripBtn" class="btn danger" disabled>Ukonƒçit stazku</button>
                </div>
            </div>

            <div class="card actions-panel">
                <h3>Akce (manu√°ln√≠ p≈ôepnut√≠)</h3>
                <div class="action-buttons">
                    <button class="action-btn" data-act="driving">üöõ J√≠zda</button>
                    <button class="action-btn" data-act="loading">üì¶ Nakl√°dka</button>
                    <button class="action-btn" data-act="unloading">üì§ Vykl√°dka</button>
                    <button class="action-btn" data-act="break">‚òï P≈ôest√°vka</button>
                    <button class="action-btn" data-act="idle">‚è∏Ô∏è Prostoj</button>
                    <button class="action-btn" data-act="fuel">‚õΩ Tankov√°n√≠</button>
                    <button class="action-btn" data-act="maintenance">üîß √ödr≈æba</button>
                </div>
            </div>

            <div class="card">
                <h3>Log</h3>
                <div class="log" id="log"></div>
            </div>
        </div>

        <div class="content">
            <div class="card map-wrap">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Mapa a trasa</h3>
                    <div class="actions">
                        <button id="exportCsvBtn" class="btn ghost">Export CSV</button>
                        <button id="exportJsonBtn" class="btn ghost">Export JSON</button>
                        <button id="newTripBtn" class="btn primary">Start stazky</button>
                    </div>
                </div>
                <div class="map" id="map">
                    <div class="road road-h"></div>
                    <div class="road road-v"></div>
                    <div class="vehicle idle" id="vehicle" style="left:45%; top:45%;">üöõ</div>
                </div>
                <div class="kpis">
                    <div class="kpi"><div class="val" id="kpi-trip-km">0</div><div class="lbl">km stazka</div></div>
                    <div class="kpi"><div class="val" id="kpi-trip-time">0:00</div><div class="lbl">doba stazky</div></div>
                </div>
            </div>

            <div class="card" id="summaryCard" style="display:none;">
                <h3>Souhrn stazky</h3>
                <div id="summaryContent" class="muted"></div>
            </div>
        </div>
    </div>

    <!-- Modal: 1) Ridic/vozidlo -->
    <div class="modal-backdrop" id="modalProfile">
        <div class="modal">
            <h2>≈òidiƒç a vozidlo</h2>
            <p class="muted" style="margin-bottom:.5rem;">Vypl≈àte pros√≠m identifikaƒçn√≠ √∫daje.</p>
            <div class="controls">
                <div class="grid-2">
                    <div class="row"><label>≈òidiƒç</label><input id="m_driverName"></div>
                    <div class="row"><label>ID ≈ôidiƒçe</label><input id="m_driverId"></div>
                </div>
                <div class="row"><label>RZ vozidla</label><input id="m_vehiclePlate"></div>
            </div>
            <div class="footer">
                <button id="profileSaveBtn" class="btn primary">Pokraƒçovat</button>
            </div>
        </div>
    </div>

    <!-- Modal: 2) Start stazky -->
    <div class="modal-backdrop" id="modalStartTrip">
        <div class="modal">
            <h2>Start stazky</h2>
            <div class="controls">
                <div class="grid-2">
                    <div class="row"><label>ƒå√≠slo stazky</label><input id="m_tripNo" type="number"></div>
                    <div class="row"><label>Start ƒças</label><input id="m_startTime" type="datetime-local"></div>
                </div>
                <div class="row inline">
                    <div class="row"><label>Start m√≠sto</label><input id="m_startPlace" placeholder="Z GPS nebo uprav"></div>
                    <button id="m_fillStartGps" class="btn">Z GPS</button>
                </div>
                <div class="grid-2">
                    <div class="row"><label>Tachometr (km)</label><input id="m_odoStart" type="number" inputmode="decimal"></div>
                    <div class="row"><label>Palivo v n√°dr≈æi (l)</label><input id="m_fuelStart" type="number" inputmode="decimal" step="0.1"></div>
                </div>
                <div class="grid-2">
                    <div class="row"><label>Objednatel</label><input id="m_client"></div>
                    <div class="row"><label>Pro koho</label><input id="m_for"></div>
                </div>
                <div class="grid-2">
                    <div class="row"><label>Co se veze</label><input id="m_cargo"></div>
                    <div class="row"><label>Mno≈æstv√≠ (ks/kg/t/m¬≥)</label><input id="m_qty" type="number" inputmode="decimal"></div>
                </div>
            </div>
            <div class="footer">
                <button id="startTripCancel" class="btn">Zpƒõt</button>
                <button id="startTripNext" class="btn primary">Pokraƒçovat</button>
            </div>
        </div>
    </div>

    <!-- Modal: 4) √ödr≈æba p≈ôed j√≠zdou -->
    <div class="modal-backdrop" id="modalMaintenance">
        <div class="modal">
            <h2>Prov√°dƒõt √∫dr≈æbu vozidla?</h2>
            <p class="muted">M≈Ø≈æete rovnou zah√°jit re≈æim √∫dr≈æby (PTO, servis) nebo zaƒç√≠t j√≠zdou.</p>
            <div class="footer">
                <button id="maintNo" class="btn">Ne, zaƒç√≠t j√≠zdou</button>
                <button id="maintYes" class="btn">Ano, √∫dr≈æba</button>
            </div>
        </div>
    </div>

    <!-- Modal: 6) Zastaven√≠ >10s ‚Äì nab√≠dka akc√≠ -->
    <div class="modal-backdrop" id="modalStopped">
        <div class="modal">
            <h2>Vozidlo stoj√≠ d√©le ne≈æ 10 s</h2>
            <p class="muted" style="margin-bottom:.5rem;">Zvolte, co se dƒõje:</p>
            <div class="actions" style="flex-wrap:wrap;">
                <button class="btn" data-stop-act="loading">Nakl√°dka</button>
                <button class="btn" data-stop-act="unloading">Vykl√°dka</button>
                <button class="btn" data-stop-act="idle">Prostoj</button>
                <button class="btn" data-stop-act="break">P≈ôest√°vka</button>
                <button class="btn" data-stop-act="maintenance">√ödr≈æba</button>
                <button class="btn" data-stop-act="fuel">Tankov√°n√≠</button>
                <button class="btn" data-stop-act="dismiss">Ignorovat</button>
            </div>
        </div>
    </div>

    <!-- Modal: 8) Ukonƒçen√≠ stazky -->
    <div class="modal-backdrop" id="modalEndTrip">
        <div class="modal">
            <h2>Ukonƒçit stazku</h2>
            <div class="controls">
                <div class="grid-2">
                    <div class="row"><label>Konec ƒças</label><input id="m_endTime" type="datetime-local"></div>
                    <div class="row"><label>Konec m√≠sto</label><input id="m_endPlace"></div>
                </div>
                <div class="grid-2">
                    <div class="row"><label>Tachometr (km)</label><input id="m_odoEnd" type="number" inputmode="decimal"></div>
                    <div class="row"><label>Palivo v n√°dr≈æi (l)</label><input id="m_fuelEnd" type="number" inputmode="decimal" step="0.1"></div>
                </div>
            </div>
            <div class="footer">
                <button id="endTripCancel" class="btn">Zpƒõt</button>
                <button id="endTripConfirm" class="btn danger">Ukonƒçit a ulo≈æit</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // --- Helpers ---
        const $ = s => document.querySelector(s);
        function showToast(msg, type='ok'){ const t=$('#toast'); t.textContent=msg; t.className='toast show ' + (type==='ok'?'ok':type); setTimeout(()=>t.classList.remove('show'),2500); }
        function fmt2(n){ return String(n).padStart(2,'0'); }
        function isoLocal(dt=new Date()){ const z=dt.getTimezoneOffset()*60000; return new Date(dt - z).toISOString().slice(0,16); }
        function haversineKm(a,b){ const R=6371, toRad=d=>d*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng); const la1=toRad(a.lat), la2=toRad(b.lat); const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }

        // --- App State ---
        const state = {
            profile: { driverName:'', driverId:'', vehiclePlate:'' },
            nextTripNo: 1,
            lastOdoKm: 0,
            lastFuelL: 0,
            gps: { lat: 50.0755, lng: 14.4378, speedKmh: 0, haveFix:false },
            route: [],
            watchId: null,
            current: {
                trip: null,            // object when running
                mode: 'idle',
                modeSince: null,
                durations: {},         // per-mode seconds accumulator
                lastPos: null,
                stopSeconds: 0
            },
            totalsOdometerKm: 0,      // rolling counter for UI
            trips: [],
            fuels: []
        };

        // --- Storage ---
        function loadStorage(){
            try{
                const saved = JSON.parse(localStorage.getItem('stazka-app')||'{}');
                if(saved.profile) state.profile = saved.profile;
                if(saved.nextTripNo) state.nextTripNo = saved.nextTripNo;
                if(typeof saved.lastOdoKm === 'number') state.lastOdoKm = saved.lastOdoKm;
                if(typeof saved.lastFuelL === 'number') state.lastFuelL = saved.lastFuelL;
                if(Array.isArray(saved.trips)) state.trips = saved.trips;
                if(Array.isArray(saved.fuels)) state.fuels = saved.fuels;
            }catch(e){}
        }
        function saveStorage(){
            const out = {
                profile: state.profile,
                nextTripNo: state.nextTripNo,
                lastOdoKm: state.lastOdoKm,
                lastFuelL: state.lastFuelL,
                trips: state.trips,
                fuels: state.fuels
            };
            try{ localStorage.setItem('stazka-app', JSON.stringify(out)); }catch(e){}
        }

        // --- UI Bindings ---
        function bindStaticUI(){
            // profile inputs mirror
            $('#driverName').addEventListener('input', e=>{ state.profile.driverName=e.target.value; saveStorage(); });
            $('#driverId').addEventListener('input', e=>{ state.profile.driverId=e.target.value; saveStorage(); });
            $('#vehiclePlate').addEventListener('input', e=>{ state.profile.vehiclePlate=e.target.value; saveStorage(); });

            // action buttons
            document.querySelectorAll('.action-btn').forEach(b=>{
                b.addEventListener('click', ()=> setMode(b.dataset.act, 'manual'));
            });

            // new trip button (open wizard)
            $('#newTripBtn').addEventListener('click', openStartTripModal);

            // end trip buttons
            $('#endTripBtn').addEventListener('click', openEndTripModal);
            $('#endTripCancel').addEventListener('click', ()=> hideModal('#modalEndTrip'));
            $('#endTripConfirm').addEventListener('click', confirmEndTrip);

            // export
            $('#exportCsvBtn').addEventListener('click', exportCsv);
            $('#exportJsonBtn').addEventListener('click', exportJson);

            // stopped modal options
            document.querySelectorAll('#modalStopped [data-stop-act]').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const act = btn.getAttribute('data-stop-act');
                    hideModal('#modalStopped');
                    if(act !== 'dismiss') setMode(act, 'auto-stop');
                });
            });

            // profile modal
            $('#profileSaveBtn').addEventListener('click', ()=>{
                state.profile.driverName = $('#m_driverName').value.trim();
                state.profile.driverId = $('#m_driverId').value.trim();
                state.profile.vehiclePlate = $('#m_vehiclePlate').value.trim();
                saveStorage();
                syncProfileUI();
                hideModal('#modalProfile');
                openStartTripModal(); // rovnou nab√≠dnout start
            });

            // start modal
            $('#startTripCancel').addEventListener('click', ()=> hideModal('#modalStartTrip'));
            $('#m_fillStartGps').addEventListener('click', ()=> { $('#m_startPlace').value = gpsString(); });
            $('#startTripNext').addEventListener('click', ()=>{
                // save draft to state.current.tripDraft
                const tripNo = parseInt($('#m_tripNo').value||state.nextTripNo);
                const startAt = new Date($('#m_startTime').value);
                const startPlace = $('#m_startPlace').value.trim() || gpsString();
                const odoStart = parseFloat($('#m_odoStart').value||state.lastOdoKm||0);
                const fuelStart = parseFloat($('#m_fuelStart').value||state.lastFuelL||0);
                const client = $('#m_client').value.trim();
                const forWho = $('#m_for').value.trim();
                const cargo = $('#m_cargo').value.trim();
                const qty = parseFloat($('#m_qty').value||'0');

                state.current.tripDraft = { tripNo, startAt, startPlace, odoStart, fuelStart, client, forWho, cargo, qty };
                hideModal('#modalStartTrip');
                // ask maintenance
                showModal('#modalMaintenance');
            });

            // maintenance modal
            $('#maintNo').addEventListener('click', ()=>{ hideModal('#modalMaintenance'); startTrip('driving'); });
            $('#maintYes').addEventListener('click', ()=>{ hideModal('#modalMaintenance'); startTrip('maintenance'); });
        }

        function syncProfileUI(){
            $('#driverName').value = state.profile.driverName || '';
            $('#driverId').value = state.profile.driverId || '';
            $('#vehiclePlate').value = state.profile.vehiclePlate || '';
        }
        function syncRunningUI(){
            $('#status-time').textContent = new Date().toLocaleTimeString('cs-CZ');
            $('#status-gps').textContent = state.gps.haveFix ? 'GPS aktivn√≠' : 'GPS ƒçek√°m...';
            $('#kpi-speed').textContent = Math.round(state.gps.speedKmh);
            $('#kpi-odo').textContent = Math.round(state.lastOdoKm);
            $('#currentMode').value = state.current.mode;
            $('#currentGps').value = gpsString();
            const tripKm = runningTripKm();
            $('#currentDistance').value = `${tripKm.toFixed(2)} km`;
            $('#kpi-trip-km').textContent = tripKm.toFixed(1);
            $('#kpi-trip-time').textContent = runningTripTimeStr();

            if(state.current.trip){
                $('#currentTripInfo').textContent = `#${state.current.trip.tripNo} ‚Ä¢ od ${new Date(state.current.trip.startAt).toLocaleString('cs-CZ')}`;
                $('#endTripBtn').disabled = false;
            } else {
                $('#currentTripInfo').textContent = '≈Ω√°dn√° stazka nebƒõ≈æ√≠';
                $('#endTripBtn').disabled = true;
            }
        }

        function log(msg, type='info'){
            const d=document.createElement('div'); d.className='item';
            const ts = new Date().toLocaleTimeString('cs-CZ');
            d.textContent = `[${ts}] ${msg}`;
            $('#log').prepend(d);
            const items = $('#log').querySelectorAll('.item');
            if(items.length>200) items[items.length-1].remove();
        }

        // --- GPS ---
        function startGps(){
            if(!('geolocation' in navigator)) { log('GPS nen√≠ dostupn√°','err'); return; }
            if(state.watchId) return;
            state.watchId = navigator.geolocation.watchPosition(pos=>{
                state.gps.haveFix = true;
                const {latitude, longitude, speed} = pos.coords;
                const prev = state.current.lastPos;
                const now = { lat: latitude, lng: longitude, at: Date.now() };
                if(typeof speed === 'number' && !Number.isNaN(speed)) {
                    state.gps.speedKmh = Math.max(0, speed*3.6);
                } else if (prev){
                    // derive speed from distance
                    const sec = (now.at - prev.at)/1000;
                    const km = haversineKm(prev, now);
                    state.gps.speedKmh = sec>0 ? (km/sec)*3600 : state.gps.speedKmh;
                }
                // accumulate distance when trip is running
                if(state.current.trip && prev){
                    const km = haversineKm(prev, now);
                    if(km>0.005){ // filter ~5m noise
                        state.current.trip.distanceKm += km;
                        state.lastOdoKm += km;
                    }
                }
                state.current.lastPos = now;
                state.gps.lat = latitude; state.gps.lng = longitude;
                drawRoutePoint(now);
            }, err=>{
                state.gps.haveFix=false; log('GPS chyba: '+err.message,'err');
            }, { enableHighAccuracy:true, maximumAge:5000, timeout:15000 });
        }
        function gpsString(){ return `${(state.gps.lat||0).toFixed(5)}, ${(state.gps.lng||0).toFixed(5)}`; }

        // --- Map ---
        function drawRoutePoint(now){
            const map = $('#map'); if(!map) return;
            // relative placement around current center (symbolic)
            const x = 50 + ((now.lng - state.gps.lng)*3000);
            const y = 50 - ((now.lat - state.gps.lat)*3000);
            const dot = document.createElement('div');
            dot.className='route-dot';
            dot.style.left = `${Math.max(0,Math.min(98,x))}%`;
            dot.style.top  = `${Math.max(0,Math.min(98,y))}%`;
            map.appendChild(dot);
            const dots = map.querySelectorAll('.route-dot');
            if(dots.length>800){ for(let i=0;i<dots.length-800;i++) dots[i].remove(); }
            // vehicle marker jitter to show direction
            const veh = $('#vehicle');
            veh.style.left = `${50 + Math.max(-45,Math.min(45,(now.lng - state.gps.lng)*3000))}%`;
            veh.style.top  = `${50 - Math.max(-45,Math.min(45,(now.lat - state.gps.lat)*3000))}%`;
        }

        // --- Modes & timers ---
        function setMode(mode, src='auto'){
            const old = state.current.mode;
            const now = Date.now();
            if(!state.current.modeSince) state.current.modeSince = now;
            // accumulate duration to old
            const elapsed = Math.floor((now - state.current.modeSince)/1000);
            state.current.durations[old] = (state.current.durations[old]||0) + Math.max(0, elapsed);

            state.current.mode = mode;
            state.current.modeSince = now;
            const veh = $('#vehicle'); veh.className = 'vehicle ' + mode;
            $('#currentMode').value = mode;
            log(`Re≈æim: ${mode} (${src})`);
        }

        function tickPerSecond(){
            // stop detection when in driving: if speed < 2 km/h for >10s -> show modal
            if(state.current.trip){
                const speed = state.gps.speedKmh||0;
                if(state.current.mode==='driving'){
                    if(speed<2) state.current.stopSeconds++; else state.current.stopSeconds=0;
                    if(state.current.stopSeconds===10){
                        showModal('#modalStopped');
                    }
                } else {
                    state.current.stopSeconds=0;
                }
            }
            syncRunningUI();
            saveStorage();
        }

        // --- Trip lifecycle ---
        function openStartTripModal(){
            // prefill
            $('#m_tripNo').value = state.nextTripNo;
            $('#m_startTime').value = isoLocal(new Date());
            $('#m_startPlace').value = gpsString();
            $('#m_odoStart').value = Math.round(state.lastOdoKm || 0);
            $('#m_fuelStart').value = state.lastFuelL || 0;
            $('#m_client').value = '';
            $('#m_for').value = '';
            $('#m_cargo').value = '';
            $('#m_qty').value = '';
            showModal('#modalStartTrip');
        }

        function startTrip(initialMode){
            const d = state.current.tripDraft;
            if(!d){ showToast('Chyb√≠ √∫daje stazky','warn'); return; }
            const trip = {
                id: crypto?.randomUUID?.() || String(Date.now()),
                tripNo: d.tripNo,
                driverName: state.profile.driverName,
                driverId: state.profile.driverId,
                vehiclePlate: state.profile.vehiclePlate,
                startAt: d.startAt.toISOString(),
                startPlace: d.startPlace,
                startCoords: { lat: state.gps.lat, lng: state.gps.lng },
                endAt: null,
                endPlace: '',
                endCoords: null,
                odoStartKm: d.odoStart,
                odoEndKm: null,
                fuelStartL: d.fuelStart,
                fuelEndL: null,
                client: d.client,
                forWho: d.forWho,
                cargo: d.cargo,
                qty: d.qty,
                distanceKm: 0,
                durations: { driving:0, loading:0, unloading:0, idle:0, break:0, maintenance:0, fuel:0 }
            };
            state.current.trip = trip;
            state.current.durations = {...trip.durations};
            state.current.modeSince = Date.now();
            state.current.stopSeconds = 0;
            state.current.lastPos = state.current.lastPos || { lat: state.gps.lat, lng: state.gps.lng, at: Date.now() };
            state.route.length = 0;

            // adopt odo/fuel to rolling storage
            state.lastOdoKm = trip.odoStartKm;
            state.lastFuelL = trip.fuelStartL;

            // increment next trip no
            state.nextTripNo = Math.max(state.nextTripNo, (trip.tripNo||0) + 1);

            setMode(initialMode, 'start');
            $('#summaryCard').style.display = 'none';
            showToast(`Stazka #${trip.tripNo} zah√°jena`, 'ok');
            log(`Stazka #${trip.tripNo} START @ ${trip.startPlace}`);
            saveStorage();
        }

        function openEndTripModal(){
            if(!state.current.trip){ showToast('≈Ω√°dn√° stazka nebƒõ≈æ√≠','warn'); return; }
            $('#m_endTime').value = isoLocal(new Date());
            $('#m_endPlace').value = gpsString();
            $('#m_odoEnd').value = Math.round(state.lastOdoKm || 0);
            $('#m_fuelEnd').value = state.lastFuelL || 0;
            showModal('#modalEndTrip');
        }

        function confirmEndTrip(){
            const t = state.current.trip; if(!t) return;
            // accumulate current mode time before closing
            setMode(state.current.mode, 'finalize');

            t.endAt = new Date($('#m_endTime').value).toISOString();
            t.endPlace = $('#m_endPlace').value.trim() || gpsString();
            t.endCoords = { lat: state.gps.lat, lng: state.gps.lng };
            t.odoEndKm = parseFloat($('#m_odoEnd').value||state.lastOdoKm||0);
            t.fuelEndL = parseFloat($('#m_fuelEnd').value||state.lastFuelL||0);

            // distance: prefer GPS tracked, fallback to tachometer delta if greater
            const gpsKm = t.distanceKm;
            const odoKm = Math.max(0, (t.odoEndKm||0) - (t.odoStartKm||0));
            if(odoKm > gpsKm) t.distanceKm = odoKm;

            // finalize durations
            Object.assign(t.durations, state.current.durations);

            // update rolling last odo/fuel
            state.lastOdoKm = t.odoEndKm || state.lastOdoKm;
            state.lastFuelL = t.fuelEndL || state.lastFuelL;

            state.trips.push(t);
            saveStorage();

            log(`Stazka #${t.tripNo} UKONƒåENA @ ${t.endPlace} ‚Ä¢ ${t.distanceKm.toFixed(2)} km`);
            showToast('Stazka ukonƒçena','ok');
            hideModal('#modalEndTrip');

            // clear running
            state.current.trip = null;
            state.current.mode = 'idle';
            state.current.modeSince = null;
            $('#summaryCard').style.display = '';
            $('#summaryContent').innerHTML = buildSummaryHtml(t);
        }

        function runningTripKm(){
            return state.current.trip ? (state.current.trip.distanceKm||0) : 0;
        }
        function runningTripTimeStr(){
            if(!state.current.trip) return '0:00';
            const start = new Date(state.current.trip.startAt).getTime();
            const sec = Math.floor((Date.now() - start)/1000);
            const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60);
            return `${h}:${fmt2(m)}`;
        }

        function buildSummaryHtml(t){
            function fmtDur(s){ const h=Math.floor(s/3600), m=Math.floor((s%3600)/60); return `${h}:${fmt2(m)}`; }
            return `
                <div style="display:grid; gap:.4rem;">
                    <div><strong>Stazka #</strong>${t.tripNo}</div>
                    <div><strong>≈òidiƒç</strong>: ${t.driverName} (${t.driverId})</div>
                    <div><strong>Vozidlo</strong>: ${t.vehiclePlate}</div>
                    <div><strong>Od</strong>: ${new Date(t.startAt).toLocaleString('cs-CZ')} ‚Ä¢ ${t.startPlace}</div>
                    <div><strong>Do</strong>: ${new Date(t.endAt).toLocaleString('cs-CZ')} ‚Ä¢ ${t.endPlace}</div>
                    <div><strong>Vzd√°lenost</strong>: ${t.distanceKm.toFixed(2)} km</div>
                    <div><strong>Tachometr</strong>: ${t.odoStartKm} ‚Üí ${t.odoEndKm}</div>
                    <div><strong>Palivo</strong>: ${t.fuelStartL} l ‚Üí ${t.fuelEndL} l</div>
                    <div><strong>Objednatel</strong>: ${t.client||'‚Äî'} ‚Ä¢ <strong>Pro koho</strong>: ${t.forWho||'‚Äî'}</div>
                    <div><strong>N√°klad</strong>: ${t.cargo||'‚Äî'} ‚Ä¢ ${t.qty||0}</div>
                    <div style="margin-top:.4rem;"><strong>ƒåasy</strong>:
                        J√≠zda ${fmtDur(t.durations.driving||0)},
                        Nakl√°dka ${fmtDur(t.durations.loading||0)},
                        Vykl√°dka ${fmtDur(t.durations.unloading||0)},
                        Prostoj ${fmtDur(t.durations.idle||0)},
                        P≈ôest√°vka ${fmtDur(t.durations.break||0)},
                        √ödr≈æba ${fmtDur(t.durations.maintenance||0)},
                        Tankov√°n√≠ ${fmtDur(t.durations.fuel||0)}
                    </div>
                </div>
            `;
        }

        // --- Export ---
        function exportCsv(){
            const rows = [['type','time','detail']];
            state.trips.forEach(t=>{
                rows.push(['trip', t.startAt, `#${t.tripNo}; driver=${t.driverName}; vehicle=${t.vehiclePlate}; from=${t.startPlace}; to=${t.endPlace||'-'}; km=${t.distanceKm.toFixed(2)}; odo=${t.odoStartKm}->${t.odoEndKm}; fuel=${t.fuelStartL}->${t.fuelEndL}`]);
                rows.push(['durations', t.endAt||'', `driving=${t.durations.driving||0};loading=${t.durations.loading||0};unloading=${t.durations.unloading||0};idle=${t.durations.idle||0};break=${t.durations.break||0};maintenance=${t.durations.maintenance||0};fuel=${t.durations.fuel||0}`]);
            });
            const csv = rows.map(r=>r.map(x=>'"'+String(x).replaceAll('"','""')+'"').join(',')).join('\n');
            const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download=`stazky_${new Date().toISOString().slice(0,10)}.csv`; a.click();
        }
        function exportJson(){
            const data = { profile: state.profile, trips: state.trips };
            const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'})); a.download=`stazky_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }

        // --- Modals ---
        function showModal(sel){ const el=$(sel); if(!el) return; el.style.display='flex'; }
        function hideModal(sel){ const el=$(sel); if(!el) return; el.style.display='none'; }

        // --- Init ---
        function init(){
            loadStorage();
            bindStaticUI();
            syncProfileUI();
            startGps();
            setInterval(()=>{ $('#status-time').textContent=new Date().toLocaleTimeString('cs-CZ'); },1000);
            setInterval(tickPerSecond, 1000);

            // first run: ask profile if missing
            if(!state.profile.driverName || !state.profile.vehiclePlate){
                // prefill modal with saved values if any
                $('#m_driverName').value = state.profile.driverName||'';
                $('#m_driverId').value = state.profile.driverId||'';
                $('#m_vehiclePlate').value = state.profile.vehiclePlate||'';
                showModal('#modalProfile');
            }
            // default mode
            setMode('idle','init');
        }

        // --- Optional: simulated motion if GPS speed is absent (keeps UI alive) ---
        setInterval(()=>{
            if(!state.current.trip) return;
            if(!state.gps.haveFix){
                // simple simulation
                const speed = state.current.mode==='driving' ? (40+Math.random()*30) : 0;
                state.gps.speedKmh = speed;
                if(state.current.mode==='driving'){
                    const kmAdd = (speed/3600); // per second approx
                    state.current.trip.distanceKm += kmAdd;
                    state.lastOdoKm += kmAdd;
                }
            }
        },1000);

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
